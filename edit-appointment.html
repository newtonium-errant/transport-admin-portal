<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Appointment - RRTS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8em;
            font-weight: 300;
            color: white;
            margin: 0;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 0.9em;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: background-color 0.3s ease;
        }

        .nav-links a:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .nav-links a.active {
            background-color: rgba(255,255,255,0.2);
        }

        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 12px;
        }

        .card-header {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border-radius: 12px 12px 0 0 !important;
            border: none;
            padding: 1rem 1.5rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            border: none;
            border-radius: 8px;
            padding: 0.75rem 2rem;
            font-weight: 500;
            box-shadow: 0 2px 10px rgba(52, 152, 219, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2980b9 0%, #1f618d 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 2rem;
            font-weight: 500;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .client-info-section {
            background: linear-gradient(135deg, #e8f4f8 0%, #d1ecf1 100%);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 2px solid #3498db;
        }

        .appointment-info-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 2px solid #6c757d;
        }

        .readonly-field {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            color: #6c757d;
        }

        .alert {
            border-radius: 8px;
        }

        .breadcrumb {
            background: none;
            padding: 0;
            margin-bottom: 1rem;
        }

        .breadcrumb-item + .breadcrumb-item::before {
            color: #6c757d;
        }

        .breadcrumb-item a {
            color: #3498db;
            text-decoration: none;
        }

        .breadcrumb-item a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>RRTS Dashboard</h1>
        <div class="header-info">
            <span id="currentDateTime"></span>
            <span>â€¢</span>
            <span id="welcomeUser">Welcome, Admin</span>
        </div>
        <div class="nav-links">
            <a href="dashboard.html">Dashboard</a>
            <a href="client-management.html">Clients</a>
            <a href="appointment-management.html" class="active">Appointments</a>
            <a href="add-appointments.html">Add Appointments</a>
            <a href="operations.html">Operations</a>
            <a href="driver-management.html">Drivers</a>
            <a href="admin.html">Admin</a>
            <a href="#" onclick="logout()">Logout</a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="dashboard.html">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="appointment-management.html">Appointments</a></li>
                <li class="breadcrumb-item active" aria-current="page">Edit Appointment</li>
            </ol>
        </nav>

        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>
                <i class="bi bi-pencil-square me-2"></i>
                Edit Appointment
            </h2>
            <a href="appointment-management.html" class="btn btn-secondary">
                <i class="bi bi-arrow-left me-2"></i>
                Back to Appointments
            </a>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading appointment...</span>
            </div>
            <p class="mt-2">Loading appointment details...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="alert alert-danger" style="display: none;">
            <h4 class="alert-heading">Error Loading Appointment</h4>
            <p id="errorMessage">Unable to load appointment details. Please try again.</p>
            <hr>
            <a href="appointment-management.html" class="btn btn-outline-danger">Return to Appointments</a>
        </div>

        <!-- Edit Form -->
        <div id="editForm" style="display: none;">
            <!-- Client Information (Read-only) -->
            <div class="client-info-section">
                <h4 class="mb-3">
                    <i class="bi bi-person-fill me-2"></i>
                    Client Information
                </h4>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">K Number</label>
                        <input type="text" class="form-control readonly-field" id="clientKNumber" readonly>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">First Name</label>
                        <input type="text" class="form-control readonly-field" id="clientFirstName" readonly>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">Last Name</label>
                        <input type="text" class="form-control readonly-field" id="clientLastName" readonly>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Phone</label>
                        <input type="text" class="form-control readonly-field" id="clientPhone" readonly>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control readonly-field" id="clientEmail" readonly>
                    </div>
                    <div class="col-12 mb-3">
                        <label class="form-label">Address</label>
                        <input type="text" class="form-control readonly-field" id="clientAddress" readonly>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">City</label>
                        <input type="text" class="form-control readonly-field" id="clientCity" readonly>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Province</label>
                        <input type="text" class="form-control readonly-field" id="clientProvince" readonly>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Postal Code</label>
                        <input type="text" class="form-control readonly-field" id="clientPostalCode" readonly>
                    </div>
                </div>
            </div>

            <!-- Appointment Information (Editable) -->
            <div class="appointment-info-section">
                <h4 class="mb-3">
                    <i class="bi bi-calendar-event me-2"></i>
                    Appointment Details
                </h4>
                <form id="appointmentForm">
                    <input type="hidden" id="appointmentId">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="appointmentDateTime" class="form-label">Appointment Date & Time</label>
                            <input type="datetime-local" class="form-control" id="appointmentDateTime" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="pickupTime" class="form-label">Pickup Time</label>
                            <input type="datetime-local" class="form-control" id="pickupTime" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="clinicLocation" class="form-label">Clinic Location</label>
                            <select class="form-select" id="clinicLocation" required>
                                <option value="">Loading locations...</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="driverAssigned" class="form-label">Driver Assigned</label>
                            <select class="form-select" id="driverAssigned">
                                <option value="">Loading drivers...</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="transitTime" class="form-label">Transit Time (minutes)</label>
                            <input type="number" class="form-control" id="transitTime" min="1" max="300">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" required>
                                <option value="pending">Pending</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="customRate" class="form-label">Custom Rate ($)</label>
                            <input type="number" class="form-control" id="customRate" step="0.01" min="0">
                        </div>
                        <div class="col-12 mb-3">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" rows="3"></textarea>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex gap-3 justify-content-end">
                        <a href="appointment-management.html" class="btn btn-secondary">
                            <i class="bi bi-x-circle me-2"></i>
                            Cancel
                        </a>
                        <button type="submit" class="btn btn-primary" id="saveButton">
                            <span class="btn-text">
                                <i class="bi bi-check-circle me-2"></i>
                                Save Changes
                            </span>
                            <span class="loading-text" style="display: none;">
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                Saving...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let appointmentData = null;
        let clinicLocations = [];
        let drivers = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 60000);
            
            const urlParams = new URLSearchParams(window.location.search);
            const appointmentId = urlParams.get('id');
            
            if (!appointmentId) {
                showError('No appointment ID provided');
                return;
            }
            
            loadAppointmentData(appointmentId);
            loadClinicLocations();
            loadDrivers();
        });

        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('currentDateTime').textContent = now.toLocaleDateString('en-US', options);
        }

        async function loadAppointmentData(appointmentId) {
            try {
                console.log('Loading appointment with ID:', appointmentId);
                
                const response = await fetch('https://webhook-processor-production-3bb8.up.railway.app/webhook/get-appointment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: appointmentId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Appointment API response:', data);
                
                // Handle different response formats
                if (Array.isArray(data) && data.length > 0) {
                    appointmentData = data[0];
                    populateForm(appointmentData);
                    showEditForm();
                } else if (data && data.id) {
                    // Single object response
                    appointmentData = data;
                    populateForm(appointmentData);
                    showEditForm();
                } else {
                    console.error('Unexpected appointment response format:', data);
                    throw new Error('Appointment not found or invalid response format');
                }
            } catch (error) {
                console.error('Error loading appointment:', error);
                showError('Failed to load appointment: ' + error.message);
            }
        }

        async function loadClinicLocations() {
            try {
                console.log('Loading clinic locations...');
                
                const response = await fetch('https://webhook-processor-production-3bb8.up.railway.app/webhook/clinic-locations');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Clinic locations API response:', data);
                
                // Handle the actual API response format: [{ success: true, destinations: [...] }]
                let locations = [];
                if (Array.isArray(data) && data.length > 0 && data[0].destinations) {
                    locations = data[0].destinations;
                } else if (data && data.destinations && Array.isArray(data.destinations)) {
                    locations = data.destinations;
                } else {
                    console.warn('Unexpected clinic locations response format:', data);
                    locations = [];
                }
                
                clinicLocations = locations;
                const select = document.getElementById('clinicLocation');
                select.innerHTML = '<option value="">Select a clinic...</option>';
                
                if (locations.length > 0) {
                    locations.forEach(location => {
                        const option = document.createElement('option');
                        option.value = location.id;
                        option.textContent = `${location.name} - ${location.address}`;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">No clinics available</option>';
                }
                
                // Set the current clinic if appointment data is loaded
                if (appointmentData && appointmentData.clinic_id) {
                    select.value = appointmentData.clinic_id;
                }
            } catch (error) {
                console.error('Error loading clinic locations:', error);
            }
        }

        async function loadDrivers() {
            try {
                console.log('Loading drivers...');
                
                const response = await fetch('https://webhook-processor-production-3bb8.up.railway.app/webhook/allDrivers');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Drivers API response:', data);
                
                // Handle the actual API response format: [{ success: true, drivers: [...] }]
                let driverList = [];
                if (Array.isArray(data) && data.length > 0 && data[0].drivers) {
                    driverList = data[0].drivers;
                } else if (data && data.drivers && Array.isArray(data.drivers)) {
                    driverList = data.drivers;
                } else {
                    console.warn('Unexpected drivers response format:', data);
                    driverList = [];
                }
                
                drivers = driverList;
                const select = document.getElementById('driverAssigned');
                select.innerHTML = '<option value="">No driver assigned</option>';
                
                if (driverList.length > 0) {
                    driverList.forEach(driver => {
                        const option = document.createElement('option');
                        option.value = driver.id;
                        // Extract first and last name from the full name field
                        const nameParts = driver.name.split(' ');
                        const firstName = nameParts[0] || '';
                        const lastName = nameParts.slice(1).join(' ') || '';
                        option.textContent = `${firstName} ${lastName}`;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">No drivers available</option>';
                }
                
                // Set the current driver if appointment data is loaded
                if (appointmentData && appointmentData.driver_assigned) {
                    select.value = appointmentData.driver_assigned;
                }
            } catch (error) {
                console.error('Error loading drivers:', error);
            }
        }

        function populateForm(data) {
            // Client information (readonly)
            document.getElementById('clientKNumber').value = data.knumber || '';
            document.getElementById('clientFirstName').value = data.clientFirstName || '';
            document.getElementById('clientLastName').value = data.clientLastName || '';
            document.getElementById('clientPhone').value = data.clientPhone || '';
            document.getElementById('clientEmail').value = data.clientEmail || '';
            document.getElementById('clientAddress').value = data.clientAddress || '';
            document.getElementById('clientCity').value = data.clientCity || '';
            document.getElementById('clientProvince').value = data.clientProvince || '';
            document.getElementById('clientPostalCode').value = data.clientPostalCode || '';

            // Appointment information (editable)
            document.getElementById('appointmentId').value = data.id;
            
            // Convert ISO datetime to local datetime-local format
            if (data.appointmentDateTime) {
                const appointmentDate = new Date(data.appointmentDateTime);
                document.getElementById('appointmentDateTime').value = formatDateTimeLocal(appointmentDate);
            }
            
            if (data.pickupTime) {
                const pickupDate = new Date(data.pickupTime);
                document.getElementById('pickupTime').value = formatDateTimeLocal(pickupDate);
            }
            
            document.getElementById('transitTime').value = data.transitTime || '';
            document.getElementById('status').value = data.status || 'pending';
            document.getElementById('customRate').value = data.customRate || '';
            document.getElementById('notes').value = data.notes || '';
        }

        function formatDateTimeLocal(date) {
            // Convert date to local datetime-local format (YYYY-MM-DDTHH:MM)
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function showEditForm() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('editForm').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').style.display = 'block';
        }

        // Handle form submission
        document.getElementById('appointmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const saveButton = document.getElementById('saveButton');
            const btnText = saveButton.querySelector('.btn-text');
            const loadingText = saveButton.querySelector('.loading-text');
            
            // Show loading state
            saveButton.disabled = true;
            btnText.style.display = 'none';
            loadingText.style.display = 'inline-flex';
            
            try {
                const formData = {
                    id: document.getElementById('appointmentId').value,
                    appointmentDateTime: new Date(document.getElementById('appointmentDateTime').value).toISOString(),
                    pickupTime: new Date(document.getElementById('pickupTime').value).toISOString(),
                    transitTime: parseInt(document.getElementById('transitTime').value) || null,
                    status: document.getElementById('status').value,
                    notes: document.getElementById('notes').value,
                    customRate: parseFloat(document.getElementById('customRate').value) || null,
                    clinic_id: document.getElementById('clinicLocation').value || null,
                    driver_assigned: document.getElementById('driverAssigned').value || null
                };

                const response = await fetch('https://webhook-processor-production-3bb8.up.railway.app/webhook/update-appointment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    // Show success message and redirect
                    alert('Appointment updated successfully!');
                    window.location.href = 'appointment-management.html';
                } else {
                    throw new Error(result.message || 'Failed to update appointment');
                }
            } catch (error) {
                console.error('Error updating appointment:', error);
                alert('Failed to update appointment: ' + error.message);
            } finally {
                // Reset button state
                saveButton.disabled = false;
                btnText.style.display = 'inline-flex';
                loadingText.style.display = 'none';
            }
        });

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>

<!-- Version: 3.3.0 - Fixed timezone conversion issues to preserve local times as stored in database -->