<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Appointment - Rural Route Transportation Services</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .navbar-brand img { height: 40px; }
        .section-header { background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 1.5rem; border-radius: 10px 10px 0 0; }
        .main-card { border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .required { color: #dc3545; }
        .client-info-summary { background-color: #e9ecef; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; }
        .client-info-summary h6 { color: #495057; margin-bottom: 1rem; }
        .form-label { font-weight: 500; color: #495057; }
        .btn-primary { background: linear-gradient(135deg, #007bff, #0056b3); border: none; }
        .btn-primary:hover { background: linear-gradient(135deg, #0056b3, #004085); }
        .alert-warning { border-left: 4px solid #ffc107; }
        .alert-info { border-left: 4px solid #17a2b8; }
        .spinner-border-sm { width: 1rem; height: 1rem; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">
                <i class="bi bi-truck me-2"></i>Rural Route Transportation Services
            </a>
            <div class="navbar-nav ms-auto">
                <span class="nav-text text-white" id="currentDateTime"></span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Loading State -->
        <div id="loadingContainer" class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading appointment...</span>
            </div>
            <p class="mt-2">Loading appointment details...</p>
        </div>

        <!-- Error State -->
        <div id="errorContainer" class="alert alert-danger" style="display: none;">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span id="errorMessage"></span>
            <div class="mt-2">
                <button class="btn btn-outline-danger btn-sm" onclick="window.location.href='index.html'">
                    <i class="bi bi-house me-1"></i>Return Home
                </button>
            </div>
        </div>

        <!-- Edit Form -->
        <div id="editFormContainer" style="display: none;">
            <!-- Client Information Summary (Read-Only) -->
            <div id="clientInfoSummary" class="client-info-summary">
                <h6><i class="bi bi-person me-2"></i>Client Information</h6>
                <div class="row">
                    <div class="col-md-3">
                        <p><strong>K Number:</strong> <span id="clientKNumberDisplay">Loading...</span></p>
                        <p><strong>Name:</strong> <span id="clientNameDisplay">Loading...</span></p>
                    </div>
                    <div class="col-md-3">
                        <p><strong>Phone:</strong> <span id="clientPhoneDisplay">Loading...</span></p>
                        <p><strong>Email:</strong> <span id="clientEmailDisplay">Loading...</span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Address:</strong> <span id="clientAddressDisplay">Loading...</span></p>
                    </div>
                </div>
            </div>

            <!-- Edit Appointment Form -->
            <div class="card main-card">
                <div class="section-header">
                    <h5 class="mb-0">
                        <i class="bi bi-pencil-square me-2"></i>
                        Edit Appointment
                    </h5>
                </div>
                <div class="card-body">
                    <form id="editForm">
                        <input type="hidden" id="editAppointmentId">
                        
                        <!-- Date and Time Row -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Appointment Date & Time <span class="required">*</span></label>
                                <input type="datetime-local" class="form-control" id="editAppointmentTime" 
                                       onchange="calculatePickupTime()" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Transit Time (minutes)</label>
                                <input type="number" class="form-control" id="editTransitTime" 
                                       onchange="calculatePickupTime()" min="0" max="120">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Pickup Date & Time <span class="required">*</span></label>
                                <input type="datetime-local" class="form-control" id="editPickupTime" required>
                            </div>
                        </div>

                        <!-- Location Row -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Clinic Name <span class="required">*</span></label>
                                <select class="form-select" id="editLocationName" onchange="updateClinicAddress()" required>
                                    <option value="">Select a clinic location...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Clinic Address</label>
                                <input type="text" class="form-control" id="editLocationAddress" readonly>
                            </div>
                        </div>

                        <!-- Driver and Status Row -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Assigned Driver</label>
                                <select class="form-select" id="editDriver">
                                    <option value="">Select a driver...</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="editStatus">
                                    <option value="pending">Pending</option>
                                    <option value="confirmed">Confirmed</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Custom Rate ($)</label>
                                <input type="number" class="form-control" id="editCustomRate" 
                                       min="0" max="500" step="0.01">
                            </div>
                        </div>

                        <!-- Notes Row -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label">Notes or Special Requests</label>
                                <textarea class="form-control" id="editNotes" rows="3" 
                                          placeholder="Any special instructions or requests..."></textarea>
                            </div>
                        </div>

                        <!-- Notification Status Display -->
                        <div class="alert alert-info">
                            <h6><i class="bi bi-info-circle me-2"></i>Notification Status</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Client Notification:</strong> <span id="editClientNotification">Not sent</span></p>
                                    <p><strong>Client Reminder:</strong> <span id="editClientReminder">Not sent</span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Driver Notification:</strong> <span id="editDriverNotification">Not sent</span></p>
                                    <p><strong>Driver Reminder:</strong> <span id="editDriverReminder">Not sent</span></p>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="row">
                            <div class="col-12 text-center">
                                <button type="button" class="btn btn-secondary me-2" onclick="window.location.href='appointment-management.html'">
                                    <i class="bi bi-arrow-left me-1"></i>Back to Appointments
                                </button>
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="bi bi-check-circle me-1"></i>Update Appointment
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="confirmDelete()">
                                    <i class="bi bi-trash me-1"></i>Delete Appointment
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let appointmentId = null;
        let appointmentData = null;
        let clinicLocations = [];
        let allDrivers = [];

        document.addEventListener('DOMContentLoaded', function() {
            // Update date and time display
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Get appointment ID from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            appointmentId = urlParams.get('id');
            
            if (!appointmentId) {
                showError('No appointment ID provided');
                return;
            }
            
            // Load required data
            loadClinicLocations();
            loadAllDrivers();
            loadAppointmentData();
        });

        // Update date and time display (times are stored as local time, no conversion needed)
        function updateDateTime() {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            document.getElementById('currentDateTime').textContent = now.toLocaleDateString('en-US', options);
        }

        // Load clinic locations for dropdown
        async function loadClinicLocations() {
            try {
                const response = await fetch('https://webhook-processor-production-3bb8.up.railway.app/webhook/clinic-locations');
                if (response.ok) {
                    const data = await response.json();
                    clinicLocations = data.locations || [];
                    // Don't populate dropdown here - wait for appointment data to determine current location
                }
            } catch (error) {
                console.error('Error loading clinic locations:', error);
                clinicLocations = []; // Set empty array as fallback
            }
        }

        // Load all drivers for dropdown  
        async function loadAllDrivers() {
            try {
                const response = await fetch('https://webhook-processor-production-3bb8.up.railway.app/webhook/allDrivers');
                if (response.ok) {
                    const data = await response.json();
                    allDrivers = data.drivers || [];
                    populateDriverDropdown();
                }
            } catch (error) {
                console.error('Error loading drivers:', error);
            }
        }

        // Populate clinic dropdown with API locations and current appointment location
        function populateClinicDropdown(currentLocation = null) {
            const clinicSelect = document.getElementById('editLocationName');
            clinicSelect.innerHTML = '<option value="">Select a clinic location...</option>';

            // Fixed clinic addresses mapping
            const CLINIC_ADDRESSES = {
                'NuVista Psychedelic - Greenwood': '963 Central Ave, Greenwood, NS, B0P 1N0',
                'NuVista Psychedelic - New Minas': '21 Roy Avenue Suite 230, New Minas, NS B4N 3R7'
            };

            // Add the current appointment location first (if it exists and isn't in our fixed list)
            if (currentLocation && !CLINIC_ADDRESSES[currentLocation]) {
                const option = document.createElement('option');
                option.value = currentLocation;
                option.textContent = currentLocation;
                option.selected = true;
                clinicSelect.appendChild(option);
            }

            // Add fixed clinic locations
            Object.keys(CLINIC_ADDRESSES).forEach(clinic => {
                const option = document.createElement('option');
                option.value = clinic;
                option.textContent = clinic;
                if (currentLocation === clinic) {
                    option.selected = true;
                }
                clinicSelect.appendChild(option);
            });

            // Add any additional locations from API that aren't already included
            if (clinicLocations && clinicLocations.length > 0) {
                clinicLocations.forEach(location => {
                    // Only add if not already in our fixed list
                    if (!CLINIC_ADDRESSES[location.name] && location.name !== currentLocation) {
                        const option = document.createElement('option');
                        option.value = location.name;
                        option.textContent = location.name;
                        clinicSelect.appendChild(option);
                    }
                });
            }
        }

        // Update clinic address when clinic selection changes
        function updateClinicAddress() {
            const clinicSelect = document.getElementById('editLocationName');
            const addressInput = document.getElementById('editLocationAddress');
            const selectedClinic = clinicSelect.value;

            // Fixed clinic addresses mapping
            const CLINIC_ADDRESSES = {
                'NuVista Psychedelic - Greenwood': '963 Central Ave, Greenwood, NS, B0P 1N0',
                'NuVista Psychedelic - New Minas': '21 Roy Avenue Suite 230, New Minas, NS B4N 3R7'
            };

            if (CLINIC_ADDRESSES[selectedClinic]) {
                addressInput.value = CLINIC_ADDRESSES[selectedClinic];
            } else {
                // Try to find address in API locations
                const location = clinicLocations.find(loc => loc.name === selectedClinic);
                if (location) {
                    addressInput.value = location.address;
                } else {
                    addressInput.value = selectedClinic; // Fallback to name
                }
            }
        }

        // Populate driver dropdown using firstname lastname (not name field)
        function populateDriverDropdown() {
            const driverSelect = document.getElementById('editDriver');
            driverSelect.innerHTML = '<option value="">Select a driver...</option>';

            if (allDrivers && allDrivers.length > 0) {
                allDrivers.forEach(driver => {
                    const option = document.createElement('option');
                    option.value = driver.id;
                    // Use firstname and lastname fields, not name
                    const firstName = driver.firstname || driver.first_name || '';
                    const lastName = driver.lastname || driver.last_name || '';
                    const displayName = `${firstName} ${lastName}`.trim() || driver.name || `Driver ${driver.id}`;
                    option.textContent = displayName;
                    driverSelect.appendChild(option);
                });
            }
        }

        // Load appointment data
        async function loadAppointmentData() {
            try {
                const response = await fetch('https://webhook-processor-production-3bb8.up.railway.app/webhook/get-appointment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        appointmentId: appointmentId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.found && data.appointment) {
                    appointmentData = data.appointment;
                    populateForm(appointmentData);
                    
                    document.getElementById('loadingContainer').style.display = 'none';
                    document.getElementById('editFormContainer').style.display = 'block';
                } else {
                    throw new Error(data.message || 'Appointment not found');
                }

            } catch (error) {
                console.error('Error loading appointment:', error);
                showError('Failed to load appointment: ' + error.message);
            }
        }

        // Populate form with appointment data
        function populateForm(appointment) {
            // Basic appointment data
            document.getElementById('editAppointmentId').value = appointment.id;
            document.getElementById('editAppointmentTime').value = formatDateTimeForInput(appointment.appointmenttime);
            document.getElementById('editPickupTime').value = formatDateTimeForInput(appointment.pickuptime);
            document.getElementById('editTransitTime').value = appointment.transittime || '';
            document.getElementById('editNotes').value = appointment.notes || '';
            document.getElementById('editStatus').value = appointment.appointmentstatus || 'pending';
            document.getElementById('editCustomRate').value = appointment.custom_rate || '';

            // Client information (read-only display)
            document.getElementById('clientKNumberDisplay').textContent = appointment.knumber || 'N/A';
            document.getElementById('clientNameDisplay').textContent = 
                `${appointment.firstname || ''} ${appointment.lastname || ''}`.trim() || 'N/A';
            document.getElementById('clientPhoneDisplay').textContent = appointment.phone || 'N/A';
            document.getElementById('clientEmailDisplay').textContent = appointment.email || 'N/A';
            
            // Build address display
            const addressParts = [
                appointment.civicaddress,
                appointment.city,
                appointment.prov,
                appointment.postalcode
            ].filter(Boolean);
            document.getElementById('clientAddressDisplay').textContent = 
                addressParts.join(', ') || 'N/A';

            // Populate clinic dropdown and set current selection
            populateClinicDropdown(appointment.locationname);
            document.getElementById('editLocationAddress').value = appointment.locationaddress || '';

            // Set driver selection
            if (appointment.driver_assigned) {
                document.getElementById('editDriver').value = appointment.driver_assigned;
            }

            // Notification status
            document.getElementById('editClientNotification').textContent = 
                appointment.client_notification_sent ? 'Sent' : 'Not sent';
            document.getElementById('editDriverNotification').textContent = 
                appointment.driver_notification_sent ? 'Sent' : 'Not sent';
            document.getElementById('editClientReminder').textContent = 
                appointment.reminder_sent_client ? 'Sent' : 'Not sent';
            document.getElementById('editDriverReminder').textContent = 
                appointment.reminder_sent_driver ? 'Sent' : 'Not sent';
        }

        // Format datetime for HTML input
        function formatDateTimeForInput(dateTimeString) {
            if (!dateTimeString) return '';
            
            try {
                // Parse the datetime string and format for input
                const date = new Date(dateTimeString);
                if (isNaN(date.getTime())) return '';
                
                // Return local datetime string for input (no timezone conversion)
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            } catch (error) {
                console.error('Error formatting datetime:', error);
                return '';
            }
        }

        // Calculate pickup time based on appointment time and transit time
        function calculatePickupTime() {
            const appointmentTimeInput = document.getElementById('editAppointmentTime');
            const transitTimeInput = document.getElementById('editTransitTime');
            const pickupTimeInput = document.getElementById('editPickupTime');

            if (appointmentTimeInput.value && transitTimeInput.value) {
                const appointmentTime = new Date(appointmentTimeInput.value);
                const transitMinutes = parseInt(transitTimeInput.value) || 0;
                
                // Subtract transit time from appointment time to get pickup time
                const pickupTime = new Date(appointmentTime.getTime() - (transitMinutes * 60000));
                pickupTimeInput.value = formatDateTimeForInput(pickupTime.toISOString());
            }
        }

        // Show error message
        function showError(message) {
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('editFormContainer').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorContainer').style.display = 'block';
        }

        // Confirm deletion
        function confirmDelete() {
            if (confirm('Are you sure you want to delete this appointment? This action cannot be undone.')) {
                deleteAppointment();
            }
        }

        // Delete appointment
        async function deleteAppointment() {
            try {
                const response = await fetch('https://webhook-processor-production-3bb8.up.railway.app/webhook/delete-appointment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        appointmentId: appointmentId
                    })
                });

                if (response.ok) {
                    alert('Appointment deleted successfully');
                    window.location.href = 'appointment-management.html';
                } else {
                    throw new Error('Failed to delete appointment');
                }
            } catch (error) {
                console.error('Error deleting appointment:', error);
                alert('Error deleting appointment: ' + error.message);
            }
        }

        // Handle form submission
        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Updating...';
            submitButton.disabled = true;

            try {
                const formData = {
                    appointmentId: document.getElementById('editAppointmentId').value,
                    appointmentTime: document.getElementById('editAppointmentTime').value,
                    pickupTime: document.getElementById('editPickupTime').value,
                    transitTime: parseInt(document.getElementById('editTransitTime').value) || null,
                    locationName: document.getElementById('editLocationName').value,
                    locationAddress: document.getElementById('editLocationAddress').value,
                    driverAssigned: document.getElementById('editDriver').value || null,
                    status: document.getElementById('editStatus').value,
                    customRate: parseFloat(document.getElementById('editCustomRate').value) || null,
                    notes: document.getElementById('editNotes').value
                };

                const response = await fetch('https://webhook-processor-production-3bb8.up.railway.app/webhook/update-appointment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Appointment updated successfully!');
                    window.location.href = 'appointment-management.html';
                } else {
                    throw new Error('Failed to update appointment');
                }

            } catch (error) {
                console.error('Error updating appointment:', error);
                alert('Error updating appointment: ' + error.message);
            } finally {
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }
        });
    </script>
</body>
</html>

<!-- Version: v1.6.0 - Client fields read-only display only, clinic dropdown with API + fixed locations, driver dropdown uses firstname/lastname -->
<!-- - v1.0.0: Standalone edit page with appointment data loading, form validation, and update functionality -->
<!-- - v1.1.0: Added clinic dropdown, driver dropdown, full client editing, notification status display, and improved data handling -->
<!-- - v1.2.0: Integrated with new get-appointment API endpoint, enhanced error handling, and warning display for client lookup issues -->
<!-- - v1.3.0: Changed API call from GET to POST method to resolve CORS issues with n8n webhook -->
<!-- - v1.4.0: Made client details read-only, clinic dropdown includes current + API locations with auto-address fill, driver dropdown uses firstname lastname -->
<!-- - v1.5.0: Removed timezone conversion as times are stored in local time, confirmed all client fields properly read-only -->
<!-- - v1.6.0: Client fields read-only display only, clinic dropdown with API + fixed locations, driver dropdown uses firstname/lastname -->