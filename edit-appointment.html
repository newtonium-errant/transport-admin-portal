<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Appointment - Rural Route Transportation Services</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .navbar-brand img { height: 40px; }
        .section-header { background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 1.5rem; border-radius: 10px 10px 0 0; }
        .main-card { border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .required { color: #dc3545; }
        .client-info-summary { background-color: #e9ecef; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; }
        .client-info-summary h6 { color: #495057; margin-bottom: 1rem; }
        .form-label { font-weight: 500; color: #495057; }
        .btn-primary { background: linear-gradient(135deg, #007bff, #0056b3); border: none; }
        .btn-primary:hover { background: linear-gradient(135deg, #0056b3, #004085); }
        .alert-warning { border-left: 4px solid #ffc107; }
        .alert-info { border-left: 4px solid #17a2b8; }
        .spinner-border-sm { width: 1rem; height: 1rem; }
        .time-input-group { display: flex; align-items: center; gap: 0.5rem; }
        .time-display { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 0.375rem 0.75rem; font-size: 1.1em; color: #495057; min-width: 120px; text-align: center; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">
                <i class="bi bi-truck me-2"></i>Rural Route Transportation Services
            </a>
            <div class="navbar-nav ms-auto">
                <span class="nav-text text-white" id="currentDateTime"></span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Loading State -->
        <div id="loadingContainer" class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading appointment...</span>
            </div>
            <p class="mt-2">Loading appointment details...</p>
        </div>

        <!-- Error State -->
        <div id="errorContainer" class="alert alert-danger" style="display: none;">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span id="errorMessage"></span>
            <div class="mt-2">
                <button class="btn btn-outline-danger btn-sm" onclick="window.location.href='index.html'">
                    <i class="bi bi-house me-1"></i>Return Home
                </button>
            </div>
        </div>

        <!-- Edit Form -->
        <div id="editFormContainer" style="display: none;">
            <!-- Client Information Summary (Read-Only) -->
            <div id="clientInfoSummary" class="client-info-summary">
                <h6><i class="bi bi-person me-2"></i>Client Information</h6>
                <div class="row">
                    <div class="col-md-3">
                        <p><strong>K Number:</strong> <span id="clientKNumberDisplay">Loading...</span></p>
                        <p><strong>Name:</strong> <span id="clientNameDisplay">Loading...</span></p>
                    </div>
                    <div class="col-md-3">
                        <p><strong>Phone:</strong> <span id="clientPhoneDisplay">Loading...</span></p>
                        <p><strong>Email:</strong> <span id="clientEmailDisplay">Loading...</span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Address:</strong> <span id="clientAddressDisplay">Loading...</span></p>
                    </div>
                </div>
            </div>

            <!-- Edit Appointment Form -->
            <div class="card main-card">
                <div class="section-header">
                    <h5 class="mb-0">
                        <i class="bi bi-pencil-square me-2"></i>
                        Edit Appointment
                    </h5>
                </div>
                <div class="card-body">
                    <form id="editForm">
                        <input type="hidden" id="editAppointmentId">
                        
                        <!-- Date Row -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Appointment Date <span class="required">*</span></label>
                                <input type="date" class="form-control" id="editAppointmentDate" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Appointment Time <span class="required">*</span></label>
                                <div class="time-input-group">
                                    <input type="time" class="form-control" id="editAppointmentTime" onchange="calculatePickupTime()" required>
                                    <div class="time-display" id="appointmentTimeDisplay">--:-- --</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Transit Time (minutes)</label>
                                <input type="number" class="form-control" id="editTransitTime" 
                                       onchange="calculatePickupTime()" min="0" max="120">
                            </div>
                        </div>

                        <!-- Pickup Time Row -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Pickup Date <span class="required">*</span></label>
                                <input type="date" class="form-control" id="editPickupDate" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Pickup Time <span class="required">*</span></label>
                                <div class="time-input-group">
                                    <input type="time" class="form-control" id="editPickupTime" required>
                                    <div class="time-display" id="pickupTimeDisplay">--:-- --</div>
                                </div>
                            </div>
                        </div>

                        <!-- Location Row -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Clinic Name <span class="required">*</span></label>
                                <select class="form-select" id="editLocationName" onchange="updateClinicAddress()" required>
                                    <option value="">Select a clinic location...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Clinic Address</label>
                                <input type="text" class="form-control" id="editLocationAddress" readonly>
                            </div>
                        </div>

                        <!-- Driver and Status Row -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Assigned Driver</label>
                                <select class="form-select" id="editDriver">
                                    <option value="">Select a driver...</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="editStatus">
                                    <option value="pending">Pending</option>
                                    <option value="confirmed">Confirmed</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Custom Rate ($)</label>
                                <input type="number" class="form-control" id="editCustomRate" min="0" step="0.01">
                            </div>
                        </div>

                        <!-- Notes Row -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="form-label">Appointment Notes</label>
                                <textarea class="form-control" id="editNotes" rows="3" 
                                          placeholder="Special instructions, accessibility requirements, etc."></textarea>
                            </div>
                        </div>

                        <!-- Notification Status (Read-Only) -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label class="form-label">Client Notification</label>
                                <p class="form-control-plaintext" id="editClientNotification">Not sent</p>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Driver Notification</label>
                                <p class="form-control-plaintext" id="editDriverNotification">Not sent</p>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Client Reminder</label>
                                <p class="form-control-plaintext" id="editClientReminder">Not sent</p>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Driver Reminder</label>
                                <p class="form-control-plaintext" id="editDriverReminder">Not sent</p>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex gap-2 justify-content-end">
                                    <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='appointment-management.html'">
                                        <i class="bi bi-arrow-left me-1"></i>Back to Appointments
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check-lg me-1"></i>Save Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let appointmentId = null;
        let appointmentData = null;
        let clinicLocations = [];
        let allDrivers = [];

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Update date/time display
            updateDateTime();
            setInterval(updateDateTime, 1000);

            // Get appointment ID from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            appointmentId = urlParams.get('id');

            if (!appointmentId) {
                showError('No appointment ID provided in URL parameters.');
                return;
            }

            // Load initial data
            await Promise.all([
                loadClinicLocations(),
                loadDrivers(),
                loadAppointmentData()
            ]);

            // Add event listeners for time display updates
            document.getElementById('editAppointmentTime').addEventListener('change', updateTimeDisplays);
            document.getElementById('editPickupTime').addEventListener('change', updateTimeDisplays);
        });

        // Update current date/time display
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit',
                timeZone: 'America/Halifax'
            };
            document.getElementById('currentDateTime').textContent = now.toLocaleDateString('en-CA', options);
        }

        // Load appointment data - Fixed to handle workflow response format
        async function loadAppointmentData() {
            try {
                const response = await fetch('https://webhook-processor-production-3bb8.up.railway.app/webhook/get-appointment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        appointmentId: appointmentId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('API Response:', data);
                
                // Handle the workflow response format - data is an array with the appointment object
                if (Array.isArray(data) && data.length > 0 && data[0].success) {
                    appointmentData = data[0];
                    populateForm(appointmentData);
                    
                    document.getElementById('loadingContainer').style.display = 'none';
                    document.getElementById('editFormContainer').style.display = 'block';
                } else if (data.error) {
                    throw new Error(data.message || data.error);
                } else {
                    throw new Error('Appointment not found or invalid response format');
                }

            } catch (error) {
                console.error('Error loading appointment:', error);
                showError('Failed to load appointment: ' + error.message);
            }
        }

        // Show error function
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');
            
            if (errorContainer && errorMessage) {
                errorMessage.textContent = message;
                errorContainer.style.display = 'block';
                document.getElementById('loadingContainer').style.display = 'none';
            } else {
                alert('Error: ' + message);
            }
        }

        // Parse datetime string as local time (no timezone conversion)
        function parseAsLocalTime(dateTimeString) {
            if (!dateTimeString) return null;
            
            // Remove timezone info and normalize format
            let normalizedStr = dateTimeString;
            if (normalizedStr.includes('+') || normalizedStr.includes('Z')) {
                normalizedStr = normalizedStr.split('+')[0].split('Z')[0];
            }
            normalizedStr = normalizedStr.replace(' ', 'T');
            
            // Parse components manually to avoid timezone conversion
            const parts = normalizedStr.split('T');
            if (parts.length !== 2) return null;
            
            const [datePart, timePart] = parts;
            const [year, month, day] = datePart.split('-').map(Number);
            const [hours, minutes, seconds] = timePart.split(':').map(Number);
            
            return new Date(year, month - 1, day, hours, minutes, seconds || 0);
        }

        // Populate form with appointment data
        function populateForm(data) {
            // Set appointment ID
            document.getElementById('editAppointmentId').value = data.id || '';
            
            // Parse appointment datetime as local time
            const appointmentDateTime = parseAsLocalTime(data.appointmentDateTime);
            if (appointmentDateTime) {
                document.getElementById('editAppointmentDate').value = appointmentDateTime.toISOString().split('T')[0];
                document.getElementById('editAppointmentTime').value = 
                    appointmentDateTime.toTimeString().slice(0, 5); // HH:MM format
            }
            
            // Parse pickup datetime as local time
            const pickupDateTime = parseAsLocalTime(data.pickupTime);
            if (pickupDateTime) {
                document.getElementById('editPickupDate').value = pickupDateTime.toISOString().split('T')[0];
                document.getElementById('editPickupTime').value = 
                    pickupDateTime.toTimeString().slice(0, 5); // HH:MM format
            }
            
            // Set other form fields
            document.getElementById('editTransitTime').value = data.transitTime || '';
            document.getElementById('editNotes').value = data.notes || '';
            document.getElementById('editStatus').value = data.status || 'pending';
            document.getElementById('editCustomRate').value = data.customRate || '';

            // Client information display
            document.getElementById('clientKNumberDisplay').textContent = data.knumber || 'N/A';
            document.getElementById('clientNameDisplay').textContent = 
                `${data.clientFirstName || ''} ${data.clientLastName || ''}`.trim() || 'N/A';
            document.getElementById('clientPhoneDisplay').textContent = data.clientPhone || 'N/A';
            document.getElementById('clientEmailDisplay').textContent = data.clientEmail || 'N/A';
            
            // Build address display
            const addressParts = [
                data.clientAddress,
                data.clientCity,
                data.clientProvince,
                data.clientPostalCode
            ].filter(Boolean);
            document.getElementById('clientAddressDisplay').textContent = 
                addressParts.join(', ') || 'N/A';

            // Set location and driver
            populateClinicDropdown(data.location);
            document.getElementById('editLocationAddress').value = data.locationAddress || '';
            
            if (data.driver_assigned) {
                document.getElementById('editDriver').value = data.driver_assigned;
            }

            // Notification status
            document.getElementById('editClientNotification').textContent = 
                data.client_notification_sent ? 'Sent' : 'Not sent';
            document.getElementById('editDriverNotification').textContent = 
                data.driver_notification_sent ? 'Sent' : 'Not sent';
            document.getElementById('editClientReminder').textContent = 
                data.reminder_sent_client ? 'Sent' : 'Not sent';
            document.getElementById('editDriverReminder').textContent = 
                data.reminder_sent_driver ? 'Sent' : 'Not sent';

            // Update AM/PM time displays
            updateTimeDisplays();
        }

        // Update 12-hour AM/PM time displays
        function updateTimeDisplays() {
            const appointmentTime = document.getElementById('editAppointmentTime').value;
            const pickupTime = document.getElementById('editPickupTime').value;
            
            if (appointmentTime) {
                const display = convertTo12Hour(appointmentTime);
                document.getElementById('appointmentTimeDisplay').textContent = display;
            }
            
            if (pickupTime) {
                const display = convertTo12Hour(pickupTime);
                document.getElementById('pickupTimeDisplay').textContent = display;
            }
        }

        // Convert 24-hour time to 12-hour AM/PM format
        function convertTo12Hour(timeString) {
            if (!timeString) return '--:-- --';
            
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours);
            const min = minutes;
            
            if (hour === 0) return `12:${min} AM`;
            if (hour < 12) return `${hour}:${min} AM`;
            if (hour === 12) return `12:${min} PM`;
            return `${hour - 12}:${min} PM`;
        }

        // Calculate pickup time based on appointment time and transit time
        function calculatePickupTime() {
            const appointmentDate = document.getElementById('editAppointmentDate').value;
            const appointmentTime = document.getElementById('editAppointmentTime').value;
            const transitTime = parseInt(document.getElementById('editTransitTime').value) || 0;

            if (appointmentDate && appointmentTime && transitTime > 0) {
                // Create appointment datetime from separate date and time inputs (local time)
                const appointmentDateTime = new Date(`${appointmentDate}T${appointmentTime}:00`);
                
                // Subtract transit time to get pickup time
                const pickupDateTime = new Date(appointmentDateTime.getTime() - (transitTime * 60000));
                
                // Set pickup date and time
                document.getElementById('editPickupDate').value = pickupDateTime.toISOString().split('T')[0];
                document.getElementById('editPickupTime').value = 
                    pickupDateTime.toTimeString().slice(0, 5);
                
                // Update time displays
                updateTimeDisplays();
            }
        }

        // Load clinic locations
        async function loadClinicLocations() {
            try {
                const response = await fetch('https://webhook-processor-production-3bb8.up.railway.app/webhook/get-locations');
                if (response.ok) {
                    const data = await response.json();
                    clinicLocations = data.locations || [];
                }
            } catch (error) {
                console.error('Error loading clinic locations:', error);
                clinicLocations = [];
            }
        }

        // Load drivers
        async function loadDrivers() {
            try {
                const response = await fetch('https://webhook-processor-production-3bb8.up.railway.app/webhook/get-drivers');
                if (response.ok) {
                    const data = await response.json();
                    allDrivers = data.drivers || [];
                    populateDriverDropdown();
                }
            } catch (error) {
                console.error('Error loading drivers:', error);
                allDrivers = [];
            }
        }

        // Populate clinic dropdown
        function populateClinicDropdown(selectedClinic = '') {
            const locationSelect = document.getElementById('editLocationName');
            locationSelect.innerHTML = '<option value="">Select a clinic location...</option>';

            const CLINIC_LOCATIONS = [
                'Valley Regional Hospital - Kentville',
                'IWK Health Centre - Halifax',
                'Dartmouth General Hospital - Dartmouth',
                'Nova Scotia Hospital - Dartmouth',
                'Aberdeen Hospital - New Glasgow',
                'Colchester East Hants Health Centre - Truro',
                'Roseway Hospital - Shelburne',
                'Cobequid Community Health Centre - Lower Sackville',
                'Cape Breton Regional Hospital - Sydney',
                'Glace Bay Hospital - Glace Bay',
                'NuVista Psychedelic - New Minas',
                'Other Location'
            ];

            CLINIC_LOCATIONS.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                if (location === selectedClinic) {
                    option.selected = true;
                }
                locationSelect.appendChild(option);
            });

            if (clinicLocations && clinicLocations.length > 0) {
                clinicLocations.forEach(location => {
                    if (!CLINIC_LOCATIONS.includes(location.name)) {
                        const option = document.createElement('option');
                        option.value = location.name;
                        option.textContent = location.name;
                        if (location.name === selectedClinic) {
                            option.selected = true;
                        }
                        locationSelect.appendChild(option);
                    }
                });
            }
        }

        // Update clinic address when selection changes
        function updateClinicAddress() {
            const selectedClinic = document.getElementById('editLocationName').value;
            const addressInput = document.getElementById('editLocationAddress');

            const CLINIC_ADDRESSES = {
                'Valley Regional Hospital - Kentville': '155 Exhibition St, Kentville, NS B4N 5E3',
                'IWK Health Centre - Halifax': '5850 University Ave, Halifax, NS B3K 6R8',
                'Dartmouth General Hospital - Dartmouth': '325 Pleasant St, Dartmouth, NS B2Y 4G8',
                'Nova Scotia Hospital - Dartmouth': '300 Pleasant St, Dartmouth, NS B2Y 3Z9',
                'Aberdeen Hospital - New Glasgow': '835 East River Rd, New Glasgow, NS B2H 3S6',
                'Colchester East Hants Health Centre - Truro': '600 Abenaki Rd, Truro, NS B2N 5A1',
                'Roseway Hospital - Shelburne': '411 Sandy Point Rd, Shelburne, NS B0T 1W0',
                'Cobequid Community Health Centre - Lower Sackville': '40 Glen Allan Dr, Bridgewater, NS B4V 0G5',
                'Cape Breton Regional Hospital - Sydney': '1482 George St, Sydney, NS B1P 1P3',
                'Glace Bay Hospital - Glace Bay': '1 Sterling Dr, Glace Bay, NS B1A 6S8',
                'NuVista Psychedelic - New Minas': '21 Roy Avenue Suite 230, New Minas, NS B4N 3R7'
            };

            if (CLINIC_ADDRESSES[selectedClinic]) {
                addressInput.value = CLINIC_ADDRESSES[selectedClinic];
            } else {
                const location = clinicLocations.find(loc => loc.name === selectedClinic);
                if (location) {
                    addressInput.value = location.address;
                } else {
                    addressInput.value = selectedClinic;
                }
            }
        }

        // Populate driver dropdown
        function populateDriverDropdown() {
            const driverSelect = document.getElementById('editDriver');
            driverSelect.innerHTML = '<option value="">Select a driver...</option>';

            if (allDrivers && allDrivers.length > 0) {
                allDrivers.forEach(driver => {
                    const option = document.createElement('option');
                    option.value = driver.id;
                    const firstName = driver.firstname || driver.first_name || '';
                    const lastName = driver.lastname || driver.last_name || '';
                    const displayName = `${firstName} ${lastName}`.trim() || driver.name || `Driver ${driver.id}`;
                    option.textContent = displayName;
                    driverSelect.appendChild(option);
                });
            }
        }

        // Handle form submission
        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
                
                // Combine date and time fields into datetime strings (local time)
                const appointmentDate = document.getElementById('editAppointmentDate').value;
                const appointmentTime = document.getElementById('editAppointmentTime').value;
                const pickupDate = document.getElementById('editPickupDate').value;
                const pickupTime = document.getElementById('editPickupTime').value;
                
                const formData = {
                    appointmentId: document.getElementById('editAppointmentId').value,
                    appointmentDateTime: `${appointmentDate} ${appointmentTime}:00`,
                    pickupTime: `${pickupDate} ${pickupTime}:00`,
                    transitTime: parseInt(document.getElementById('editTransitTime').value) || null,
                    locationName: document.getElementById('editLocationName').value,
                    locationAddress: document.getElementById('editLocationAddress').value,
                    notes: document.getElementById('editNotes').value,
                    status: document.getElementById('editStatus').value,
                    driverId: document.getElementById('editDriver').value || null,
                    customRate: parseFloat(document.getElementById('editCustomRate').value) || null
                };
                
                const response = await fetch('https://webhook-processor-production-3bb8.up.railway.app/webhook/update-appointment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.innerHTML = `
                        <i class="bi bi-check-circle me-2"></i>
                        Appointment updated successfully!
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    
                    const form = document.getElementById('editForm');
                    form.parentNode.insertBefore(alertDiv, form);
                    window.scrollTo(0, 0);
                    
                    setTimeout(() => {
                        if (alertDiv.parentNode) {
                            alertDiv.remove();
                        }
                    }, 5000);
                    
                } else {
                    throw new Error(result.message || 'Failed to update appointment');
                }
                
            } catch (error) {
                console.error('Error updating appointment:', error);
                
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Failed to update appointment: ${error.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                const form = document.getElementById('editForm');
                form.parentNode.insertBefore(alertDiv, form);
                window.scrollTo(0, 0);
                
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });
    </script>
</body>
</html>

<!-- Version: v2.4.3 - Fixed clinic locations URL with debug logging -->