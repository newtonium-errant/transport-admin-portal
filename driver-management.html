<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RRTS - Driver Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8em;
            font-weight: 300;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 0.9em;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: background-color 0.3s ease;
        }

        .nav-links a:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .nav-links a.active {
            background-color: rgba(255,255,255,0.2);
        }

        .content {
            padding: 30px;
        }

        .driver-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin-bottom: 30px;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }

        .section-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .driver-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .driver-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            position: relative;
            transition: all 0.3s ease;
        }

        .driver-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .driver-card.available {
            border-color: #27ae60;
            background: #f8fff9;
        }

        .driver-card.busy {
            border-color: #f39c12;
            background: #fffbf0;
        }

        .driver-card.offline {
            border-color: #95a5a6;
            background: #f8f9fa;
            opacity: 0.8;
        }

        .driver-card.time-off {
            border-color: #e74c3c;
            background: #fef8f8;
        }

        .driver-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .driver-name {
            font-size: 1.3em;
            font-weight: 700;
            color: #2c3e50;
        }

        .driver-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-available {
            background: #d4edda;
            color: #155724;
        }

        .status-busy {
            background: #fff3cd;
            color: #856404;
        }

        .status-offline {
            background: #e2e6ea;
            color: #6c757d;
        }

        .status-time-off {
            background: #f8d7da;
            color: #721c24;
        }

        .driver-details {
            margin-bottom: 15px;
        }

        .detail-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: #666;
        }

        .detail-icon {
            margin-right: 10px;
            font-size: 1.1em;
            width: 20px;
        }

        .weekly-schedule {
            margin-top: 15px;
        }

        .schedule-title {
            font-size: 0.9em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .schedule-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .schedule-day {
            text-align: center;
            padding: 8px 4px;
            border-radius: 6px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .schedule-day.available {
            background: #d4edda;
            color: #155724;
        }

        .schedule-day.unavailable {
            background: #f8d7da;
            color: #721c24;
        }

        .driver-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .action-btn.primary {
            background: #3498db;
            color: white;
        }

        .action-btn.success {
            background: #27ae60;
            color: white;
        }

        .action-btn.warning {
            background: #f39c12;
            color: white;
        }

        .action-btn.danger {
            background: #e74c3c;
            color: white;
        }

        .action-btn.secondary {
            background: #95a5a6;
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }

        .add-driver-form {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .schedule-editor {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }

        .schedule-editor h4 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .schedule-day-editor {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 6px;
            background: #f8f9fa;
        }

        .day-name {
            width: 100px;
            font-weight: 600;
            color: #2c3e50;
        }

        .day-available {
            margin-right: 15px;
        }

        .time-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .time-inputs input {
            width: 80px;
            padding: 5px 8px;
            font-size: 0.9em;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-value.success { color: #27ae60; }
        .stat-value.warning { color: #f39c12; }
        .stat-value.danger { color: #e74c3c; }
        .stat-value.primary { color: #3498db; }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .assignment-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
        }

        .assignment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }

        .assignment-info {
            flex: 1;
        }

        .assignment-time {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .assignment-details {
            font-size: 0.9em;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #3498db;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .hidden {
            display: none;
        }

        .time-off-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e74c3c;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: 600;
        }

        .workload-indicator {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .workload-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60 0%, #f39c12 70%, #e74c3c 100%);
            transition: width 0.3s ease;
        }

        @media (max-width: 1200px) {
            .driver-grid {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }
            
            .content {
                padding: 20px;
            }

            .nav-links {
                flex-direction: column;
                gap: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .driver-list {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .schedule-days {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Driver Management</h1>
            <div class="header-info">
                <span id="currentDateTime"></span>
                <span>•</span>
                <span id="driverCount">Loading...</span>
            </div>
            <div class="nav-links">
                <a href="dashboard.html">Dashboard</a>
                <a href="client-management.html">Clients</a>
                <a href="operations.html">Operations</a>
                <a href="driver-management.html" class="active">Drivers</a>
                <a href="admin.html">Admin</a>
                <a href="#" onclick="logout()">Logout</a>
            </div>
        </div>

        <div class="content">
            <!-- Quick Stats -->
            <div class="quick-stats">
                <div class="stat-card">
                    <div class="stat-value success" id="availableDrivers">--</div>
                    <div class="stat-label">Available Now</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value warning" id="busyDrivers">--</div>
                    <div class="stat-label">Currently Busy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value danger" id="timeOffDrivers">--</div>
                    <div class="stat-label">On Time Off</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value primary" id="totalDrivers">--</div>
                    <div class="stat-label">Total Drivers</div>
                </div>
            </div>

            <div class="driver-grid">
                <!-- Main Content -->
                <div class="main-content">
                    <!-- Add/Edit Driver Form -->
                    <div class="card">
                        <h3 class="section-title">👤 Add New Driver</h3>
                        <div class="add-driver-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="driverName">Full Name *</label>
                                    <input type="text" id="driverName" required>
                                </div>
                                <div class="form-group">
                                    <label for="driverEmail">Email Address *</label>
                                    <input type="email" id="driverEmail" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="driverPhone">Phone Number</label>
                                    <input type="tel" id="driverPhone" placeholder="(902) 555-0123">
                                </div>
                                <div class="form-group">
                                    <label for="driverGender">Gender</label>
                                    <select id="driverGender">
                                        <option value="">Select Gender</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                        <option value="non-binary">Non-binary</option>
                                        <option value="prefer-not-to-say">Prefer not to say</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="workloadPreference">Workload Preference</label>
                                    <select id="workloadPreference">
                                        <option value="normal">Normal (100%)</option>
                                        <option value="reduced">Reduced (75%)</option>
                                        <option value="minimal">Minimal (50%)</option>
                                        <option value="maximum">Maximum (125%)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="calendarType">Calendar Integration</label>
                                    <select id="calendarType">
                                        <option value="google">Google Calendar</option>
                                        <option value="outlook">Outlook Calendar</option>
                                        <option value="apple">Apple Calendar</option>
                                        <option value="none">No Integration</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Weekly Schedule Editor -->
                            <div class="form-group">
                                <label>Weekly Availability Schedule</label>
                                <div class="schedule-editor">
                                    <h4>Set working hours for each day:</h4>
                                    <div id="scheduleEditor">
                                        <!-- Schedule days will be generated here -->
                                    </div>
                                </div>
                            </div>

                            <div style="text-align: center; margin-top: 20px;">
                                <button class="action-btn success" onclick="saveDriver()" style="font-size: 1.1em; padding: 12px 30px;">
                                    💾 Add Driver
                                </button>
                                <button class="action-btn secondary" onclick="clearForm()" style="margin-left: 15px;">
                                    🔄 Clear Form
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Drivers List -->
                    <div class="card">
                        <h3 class="section-title">🚗 Current Drivers</h3>
                        <div id="driversList">
                            <div class="loading">Loading drivers...</div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="sidebar">
                    <!-- Today's Assignments -->
                    <div class="card assignment-panel">
                        <h3 class="section-title">📅 Today's Assignments</h3>
                        <div id="todaysAssignments">
                            <div class="loading">Loading assignments...</div>
                        </div>
                    </div>

                    <!-- Time Off Requests -->
                    <div class="card">
                        <h3 class="section-title">🏖️ Time Off Requests</h3>
                        <div id="timeOffRequests">
                            <div class="loading">Loading time off requests...</div>
                        </div>
                        <button class="action-btn primary" onclick="addTimeOff()" style="width: 100%; margin-top: 15px;">
                            + Add Time Off
                        </button>
                    </div>

                    <!-- Driver Performance -->
                    <div class="card">
                        <h3 class="section-title">📊 Driver Performance</h3>
                        <div id="driverPerformance">
                            <div class="loading">Loading performance data...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_ENDPOINTS = {
            DRIVERS: 'https://n8n.newtonium.ca/webhook/rrts-driver-management', // TODO: Create this
            SAVE_DRIVER: 'https://n8n.newtonium.ca/webhook/rrts-save-driver', // TODO: Create this
            TIME_OFF: 'https://n8n.newtonium.ca/webhook/rrts-driver-time-off', // TODO: Create this
            ASSIGNMENTS: 'https://n8n.newtonium.ca/webhook/rrts-driver-assignments' // TODO: Create this
        };

        // Global variables
        let driversData = null;
        let editingDriverId = null;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('RRTS Driver Management Portal Loaded');
            
            // Check authentication
            const savedUser = sessionStorage.getItem('rrts_user');
            if (!savedUser) {
                window.location.href = 'dashboard.html';
                return;
            }

            updateDateTime();
            setInterval(updateDateTime, 60000); // Update every minute
            
            generateScheduleEditor();
            loadDriversData();
        });

        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            const dateTimeString = now.toLocaleDateString('en-CA', options);
            document.getElementById('currentDateTime').textContent = dateTimeString;
        }

        function generateScheduleEditor() {
            const scheduleEditor = document.getElementById('scheduleEditor');
            const days = [
                { key: 'monday', name: 'Monday' },
                { key: 'tuesday', name: 'Tuesday' },
                { key: 'wednesday', name: 'Wednesday' },
                { key: 'thursday', name: 'Thursday' },
                { key: 'friday', name: 'Friday' },
                { key: 'saturday', name: 'Saturday' },
                { key: 'sunday', name: 'Sunday' }
            ];

            scheduleEditor.innerHTML = '';
            days.forEach(day => {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'schedule-day-editor';
                
                dayDiv.innerHTML = `
                    <div class="day-name">${day.name}</div>
                    <div class="day-available">
                        <input type="checkbox" id="available-${day.key}" checked onchange="toggleDayAvailability('${day.key}')">
                        <label for="available-${day.key}">Available</label>
                    </div>
                    <div class="time-inputs" id="times-${day.key}">
                        <input type="time" id="start-${day.key}" value="08:00">
                        <span>to</span>
                        <input type="time" id="end-${day.key}" value="16:00">
                    </div>
                `;
                
                scheduleEditor.appendChild(dayDiv);
            });
        }

        function toggleDayAvailability(day) {
            const checkbox = document.getElementById(`available-${day}`);
            const timesDiv = document.getElementById(`times-${day}`);
            
            if (checkbox.checked) {
                timesDiv.style.opacity = '1';
                timesDiv.style.pointerEvents = 'auto';
            } else {
                timesDiv.style.opacity = '0.5';
                timesDiv.style.pointerEvents = 'none';
            }
        }

        async function loadDriversData() {
            try {
                // TODO: Replace with actual API call when endpoint is ready
                // const response = await fetch(API_ENDPOINTS.DRIVERS);
                // const data = await response.json();

                // Mock data based on your schema
                const mockData = generateMockDriversData();
                
                driversData = mockData;
                updateStats(mockData.stats);
                renderDriversList(mockData.drivers);
                renderTodaysAssignments(mockData.todaysAssignments);
                renderTimeOffRequests(mockData.timeOffRequests);
                renderPerformanceData(mockData.performance);

            } catch (error) {
                console.error('Failed to load drivers data:', error);
                showError('Failed to load drivers data');
            }
        }

        function generateMockDriversData() {
            // Mock data that matches your database schema
            const drivers = [
                {
                    id: 1,
                    name: 'Andrew Newton',
                    email: 'andrewnewton965@gmail.com',
                    phone: '(902) 555-0123',
                    gender: 'male',
                    is_male: true,
                    active: true,
                    workload_preference: 'normal',
                    workload_percentage: 100,
                    preferred_calendar_type: 'google',
                    google_calendar_id: 'andrew@calendar.google.com',
                    currentStatus: 'available',
                    todaysAssignments: 3,
                    weeklyHours: {
                        monday: { available: true, start: '08:00', end: '16:00' },
                        tuesday: { available: true, start: '08:00', end: '16:00' },
                        wednesday: { available: true, start: '08:00', end: '16:00' },
                        thursday: { available: true, start: '08:00', end: '16:00' },
                        friday: { available: true, start: '08:00', end: '16:00' },
                        saturday: { available: false, start: null, end: null },
                        sunday: { available: false, start: null, end: null }
                    },
                    nextAppointment: '13:30',
                    performanceRating: 4.8,
                    completedTrips: 45,
                    onTimePercentage: 95
                },
                {
                    id: 2,
                    name: 'Sarah Wilson',
                    email: 'sarah.wilson@rrts.ca',
                    phone: '(902) 555-0456',
                    gender: 'female',
                    is_male: false,
                    active: true,
                    workload_preference: 'reduced',
                    workload_percentage: 75,
                    preferred_calendar_type: 'google',
                    google_calendar_id: null,
                    currentStatus: 'time-off',
                    todaysAssignments: 0,
                    weeklyHours: {
                        monday: { available: true, start: '09:00', end: '15:00' },
                        tuesday: { available: true, start: '09:00', end: '15:00' },
                        wednesday: { available: false, start: null, end: null },
                        thursday: { available: true, start: '09:00', end: '15:00' },
                        friday: { available: true, start: '09:00', end: '15:00' },
                        saturday: { available: false, start: null, end: null },
                        sunday: { available: false, start: null, end: null }
                    },
                    nextAppointment: null,
                    performanceRating: 4.9,
                    completedTrips: 32,
                    onTimePercentage: 98,
                    timeOffReason: 'Personal leave until Friday'
                },
                {
                    id: 3,
                    name: 'Mike Johnson',
                    email: 'mike.johnson@rrts.ca',
                    phone: '(902) 555-0789',
                    gender: 'male',
                    is_male: true,
                    active: false,
                    workload_preference: 'normal',
                    workload_percentage: 100,
                    preferred_calendar_type: 'outlook',
                    google_calendar_id: null,
                    currentStatus: 'offline',
                    todaysAssignments: 0,
                    weeklyHours: {
                        monday: { available: true, start: '08:00', end: '16:00' },
                        tuesday: { available: true, start: '08:00', end: '16:00' },
                        wednesday: { available: true, start: '08:00', end: '16:00' },
                        thursday: { available: true, start: '08:00', end: '16:00' },
                        friday: { available: true, start: '08:00', end: '16:00' },
                        saturday: { available: false, start: null, end: null },
                        sunday: { available: false, start: null, end: null }
                    },
                    nextAppointment: null,
                    performanceRating: 4.6,
                    completedTrips: 28,
                    onTimePercentage: 92
                }
            ];

            return {
                drivers: drivers,
                stats: {
                    total: drivers.length,
                    available: drivers.filter(d => d.currentStatus === 'available').length,
                    busy: drivers.filter(d => d.currentStatus === 'busy').length,
                    timeOff: drivers.filter(d => d.currentStatus === 'time-off').length
                },
                todaysAssignments: [
                    {
                        driverId: 1,
                        driverName: 'Andrew Newton',
                        time: '09:00',
                        client: 'John Smith (K1234567)',
                        location: 'New Minas Clinic',
                        status: 'confirmed'
                    },
                    {
                        driverId: 1,
                        driverName: 'Andrew Newton',
                        time: '13:30',
                        client: 'Mary Johnson (K2345678)',
                        location: 'Greenwood Clinic',
                        status: 'pending'
                    },
                    {
                        driverId: 1,
                        driverName: 'Andrew Newton',
                        time: '15:45',
                        client: 'Bob Wilson (K3456789)',
                        location: 'Middleton Clinic',
                        status: 'confirmed'
                    }
                ],
                timeOffRequests: [
                    {
                        id: 1,
                        driverId: 2,
                        driverName: 'Sarah Wilson',
                        startDate: '2025-08-20',
                        endDate: '2025-08-22',
                        reason: 'Personal leave',
                        status: 'approved'
                    },
                    {
                        id: 2,
                        driverId: 1,
                        driverName: 'Andrew Newton',
                        startDate: '2025-08-30',
                        endDate: '2025-08-30',
                        reason: 'Medical appointment',
                        status: 'pending'
                    }
                ],
                performance: {
                    totalTrips: 105,
                    avgRating: 4.77,
                    onTimePercentage: 95.2,
                    topPerformer: 'Sarah Wilson'
                }
            };
        }

        function updateStats(stats) {
            document.getElementById('totalDrivers').textContent = stats.total;
            document.getElementById('availableDrivers').textContent = stats.available;
            document.getElementById('busyDrivers').textContent = stats.busy;
            document.getElementById('timeOffDrivers').textContent = stats.timeOff;
            document.getElementById('driverCount').textContent = `${stats.total} drivers • ${stats.available} available`;
        }

        function renderDriversList(drivers) {
            const container = document.getElementById('driversList');
            
            if (!drivers || drivers.length === 0) {
                container.innerHTML = '<div class="empty-state">No drivers found</div>';
                return;
            }

            const driverList = document.createElement('div');
            driverList.className = 'driver-list';

            drivers.forEach(driver => {
                const driverCard = document.createElement('div');
                driverCard.className = `driver-card ${driver.currentStatus}`;
                
                // Calculate workload indicator width
                const workloadWidth = Math.min(driver.workload_percentage, 125);
                
                // Generate schedule display
                const scheduleDisplay = generateScheduleDisplay(driver.weeklyHours);
                
                driverCard.innerHTML = `
                    ${driver.currentStatus === 'time-off' ? `<div class="time-off-badge">Time Off</div>` : ''}
                    
                    <div class="driver-header">
                        <div class="driver-name">${driver.name}</div>
                        <div class="driver-status status-${driver.currentStatus}">
                            ${driver.currentStatus === 'time-off' ? 'Time Off' : 
                              driver.currentStatus === 'available' ? 'Available' :
                              driver.currentStatus === 'busy' ? 'Busy' : 'Offline'}
                        </div>
                    </div>
                    
                    <div class="driver-details">
                        <div class="detail-row">
                            <span class="detail-icon">📧</span>
                            ${driver.email}
                        </div>
                        <div class="detail-row">
                            <span class="detail-icon">📞</span>
                            ${driver.phone || 'No phone'}
                        </div>
                        <div class="detail-row">
                            <span class="detail-icon">👤</span>
                            ${driver.gender || 'Not specified'} • ${driver.workload_preference} workload
                        </div>
                        <div class="detail-row">
                            <span class="detail-icon">📅</span>
                            ${driver.todaysAssignments} assignments today
                            ${driver.nextAppointment ? ` • Next: ${driver.nextAppointment}` : ''}
                        </div>
                        ${driver.timeOffReason ? `
                            <div class="detail-row">
                                <span class="detail-icon">🏖️</span>
                                ${driver.timeOffReason}
                            </div>
                        ` : ''}
                        <div class="detail-row">
                            <span class="detail-icon">⭐</span>
                            Rating: ${driver.performanceRating}/5 • ${driver.onTimePercentage}% on-time
                        </div>
                    </div>
                    
                    <div class="workload-indicator">
                        <div class="workload-fill" style="width: ${workloadWidth}%"></div>
                    </div>
                    
                    <div class="weekly-schedule">
                        <div class="schedule-title">Weekly Schedule:</div>
                        <div class="schedule-days">
                            ${scheduleDisplay}
                        </div>
                    </div>
                    
                    <div class="driver-actions">
                        <button class="action-btn primary" onclick="editDriver(${driver.id})">
                            ✏️ Edit
                        </button>
                        <button class="action-btn secondary" onclick="viewSchedule(${driver.id})">
                            📅 Schedule
                        </button>
                        <button class="action-btn success" onclick="contactDriver(${driver.id})">
                            📞 Contact
                        </button>
                        ${driver.currentStatus === 'time-off' ? 
                            `<button class="action-btn warning" onclick="endTimeOff(${driver.id})">🔄 Return</button>` :
                            `<button class="action-btn warning" onclick="addDriverTimeOff(${driver.id})">🏖️ Time Off</button>`
                        }
                        ${driver.active ? 
                            `<button class="action-btn danger" onclick="deactivateDriver(${driver.id})">❌ Deactivate</button>` :
                            `<button class="action-btn success" onclick="activateDriver(${driver.id})">✅ Activate</button>`
                        }
                    </div>
                `;
                
                driverList.appendChild(driverCard);
            });

            container.innerHTML = '';
            container.appendChild(driverList);
        }

        function generateScheduleDisplay(weeklyHours) {
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const dayLabels = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
            
            return days.map((day, index) => {
                const daySchedule = weeklyHours[day];
                const isAvailable = daySchedule && daySchedule.available;
                
                return `
                    <div class="schedule-day ${isAvailable ? 'available' : 'unavailable'}" 
                         title="${dayLabels[index]} ${isAvailable ? `${daySchedule.start}-${daySchedule.end}` : 'Unavailable'}">
                        ${dayLabels[index]}
                    </div>
                `;
            }).join('');
        }

        function renderTodaysAssignments(assignments) {
            const container = document.getElementById('todaysAssignments');
            
            if (!assignments || assignments.length === 0) {
                container.innerHTML = '<div class="empty-state">No assignments today</div>';
                return;
            }

            container.innerHTML = '';
            assignments.forEach(assignment => {
                const assignmentDiv = document.createElement('div');
                assignmentDiv.className = 'assignment-item';
                
                assignmentDiv.innerHTML = `
                    <div class="assignment-info">
                        <div class="assignment-time">${assignment.time}</div>
                        <div class="assignment-details">
                            ${assignment.driverName}<br>
                            ${assignment.client} → ${assignment.location}
                        </div>
                    </div>
                    <div class="assignment-status status-${assignment.status}">
                        ${assignment.status}
                    </div>
                `;
                
                container.appendChild(assignmentDiv);
            });
        }

        function renderTimeOffRequests(timeOffRequests) {
            const container = document.getElementById('timeOffRequests');
            
            if (!timeOffRequests || timeOffRequests.length === 0) {
                container.innerHTML = '<div class="empty-state">No time off requests</div>';
                return;
            }

            container.innerHTML = '';
            timeOffRequests.forEach(request => {
                const requestDiv = document.createElement('div');
                requestDiv.className = 'assignment-item';
                requestDiv.style.background = request.status === 'approved' ? '#f8fff9' : '#fff3cd';
                
                const startDate = new Date(request.startDate).toLocaleDateString('en-CA', { month: 'short', day: 'numeric' });
                const endDate = new Date(request.endDate).toLocaleDateString('en-CA', { month: 'short', day: 'numeric' });
                
                requestDiv.innerHTML = `
                    <div class="assignment-info">
                        <div class="assignment-time">${startDate} - ${endDate}</div>
                        <div class="assignment-details">
                            ${request.driverName}<br>
                            ${request.reason}
                        </div>
                    </div>
                    <div class="assignment-status" style="background: ${request.status === 'approved' ? '#27ae60' : '#f39c12'}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em;">
                        ${request.status}
                    </div>
                `;
                
                container.appendChild(requestDiv);
            });
        }

        function renderPerformanceData(performance) {
            const container = document.getElementById('driverPerformance');
            
            container.innerHTML = `
                <div class="performance-summary">
                    <div class="detail-row">
                        <span class="detail-icon">🚗</span>
                        Total trips completed: ${performance.totalTrips}
                    </div>
                    <div class="detail-row">
                        <span class="detail-icon">⭐</span>
                        Average rating: ${performance.avgRating}/5
                    </div>
                    <div class="detail-row">
                        <span class="detail-icon">⏰</span>
                        On-time percentage: ${performance.onTimePercentage}%
                    </div>
                    <div class="detail-row">
                        <span class="detail-icon">🏆</span>
                        Top performer: ${performance.topPerformer}
                    </div>
                </div>
            `;
        }

        async function saveDriver() {
            try {
                // Collect form data
                const driverData = {
                    name: document.getElementById('driverName').value.trim(),
                    email: document.getElementById('driverEmail').value.trim(),
                    phone: document.getElementById('driverPhone').value.trim(),
                    gender: document.getElementById('driverGender').value,
                    workload_preference: document.getElementById('workloadPreference').value,
                    preferred_calendar_type: document.getElementById('calendarType').value,
                    weekly_hours: collectWeeklySchedule(),
                    active: true
                };

                // Validate required fields
                if (!driverData.name || !driverData.email) {
                    showToast('Please fill in all required fields', 'error');
                    return;
                }

                // Set additional fields based on gender
                driverData.is_male = driverData.gender === 'male';
                
                // Set workload percentage based on preference
                const workloadPercentages = {
                    'minimal': 50,
                    'reduced': 75,
                    'normal': 100,
                    'maximum': 125
                };
                driverData.workload_percentage = workloadPercentages[driverData.workload_preference] || 100;

                console.log('Saving driver data:', driverData);

                // TODO: Implement actual API call
                // const response = await fetch(API_ENDPOINTS.SAVE_DRIVER, {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify(driverData)
                // });

                showToast('Driver saved successfully!', 'success');
                clearForm();
                loadDriversData(); // Refresh the drivers list

            } catch (error) {
                console.error('Failed to save driver:', error);
                showToast('Failed to save driver', 'error');
            }
        }

        function collectWeeklySchedule() {
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const schedule = {};

            days.forEach(day => {
                const available = document.getElementById(`available-${day}`).checked;
                const start = document.getElementById(`start-${day}`).value;
                const end = document.getElementById(`end-${day}`).value;

                schedule[day] = {
                    available: available,
                    start: available ? start : null,
                    end: available ? end : null
                };
            });

            return schedule;
        }

        function clearForm() {
            document.getElementById('driverName').value = '';
            document.getElementById('driverEmail').value = '';
            document.getElementById('driverPhone').value = '';
            document.getElementById('driverGender').value = '';
            document.getElementById('workloadPreference').value = 'normal';
            document.getElementById('calendarType').value = 'google';

            // Reset schedule to default (Monday-Friday 8-4)
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            days.forEach((day, index) => {
                const isWeekday = index < 5; // Monday-Friday
                document.getElementById(`available-${day}`).checked = isWeekday;
                document.getElementById(`start-${day}`).value = '08:00';
                document.getElementById(`end-${day}`).value = '16:00';
                toggleDayAvailability(day);
            });

            editingDriverId = null;
        }

        // Driver action functions
        function editDriver(driverId) {
            const driver = driversData.drivers.find(d => d.id === driverId);
            if (!driver) return;

            // Populate form with driver data
            document.getElementById('driverName').value = driver.name;
            document.getElementById('driverEmail').value = driver.email;
            document.getElementById('driverPhone').value = driver.phone || '';
            document.getElementById('driverGender').value = driver.gender || '';
            document.getElementById('workloadPreference').value = driver.workload_preference;
            document.getElementById('calendarType').value = driver.preferred_calendar_type;

            // Populate weekly schedule
            Object.keys(driver.weeklyHours).forEach(day => {
                const daySchedule = driver.weeklyHours[day];
                document.getElementById(`available-${day}`).checked = daySchedule.available;
                document.getElementById(`start-${day}`).value = daySchedule.start || '08:00';
                document.getElementById(`end-${day}`).value = daySchedule.end || '16:00';
                toggleDayAvailability(day);
            });

            editingDriverId = driverId;
            
            // Update button text
            const saveButton = document.querySelector('.action-btn.success');
            saveButton.innerHTML = '💾 Update Driver';
            
            // Scroll to form
            document.querySelector('.add-driver-form').scrollIntoView({ behavior: 'smooth' });
            
            showToast(`Editing ${driver.name}`, 'info');
        }

        function viewSchedule(driverId) {
            const driver = driversData.drivers.find(d => d.id === driverId);
            showToast(`Opening schedule for ${driver.name}...`, 'info');
            // TODO: Implement schedule view modal
        }

        function contactDriver(driverId) {
            const driver = driversData.drivers.find(d => d.id === driverId);
            showToast(`Contacting ${driver.name}...`, 'info');
            // TODO: Implement contact options (call/email/SMS)
        }

        function addDriverTimeOff(driverId) {
            const driver = driversData.drivers.find(d => d.id === driverId);
            showToast(`Adding time off for ${driver.name}...`, 'info');
            // TODO: Implement time off request form
        }

        function endTimeOff(driverId) {
            const driver = driversData.drivers.find(d => d.id === driverId);
            if (confirm(`Return ${driver.name} from time off?`)) {
                showToast(`${driver.name} returned from time off`, 'success');
                // TODO: Implement return from time off
                loadDriversData();
            }
        }

        function activateDriver(driverId) {
            const driver = driversData.drivers.find(d => d.id === driverId);
            if (confirm(`Activate ${driver.name}?`)) {
                showToast(`${driver.name} activated`, 'success');
                // TODO: Implement driver activation
                loadDriversData();
            }
        }

        function deactivateDriver(driverId) {
            const driver = driversData.drivers.find(d => d.id === driverId);
            if (confirm(`Deactivate ${driver.name}? They will no longer receive new assignments.`)) {
                showToast(`${driver.name} deactivated`, 'warning');
                // TODO: Implement driver deactivation
                loadDriversData();
            }
        }

        function addTimeOff() {
            showToast('Opening time off request form...', 'info');
            // TODO: Implement time off request form modal
        }

        function showToast(message, type = 'info') {
            // Create toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
                max-width: 300px;
                word-wrap: break-word;
            `;

            const colors = {
                success: '#27ae60',
                error: '#e74c3c',
                warning: '#f39c12',
                info: '#3498db'
            };

            toast.style.backgroundColor = colors[type] || colors.info;
            toast.textContent = message;

            document.body.appendChild(toast);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showError(message) {
            const driversList = document.getElementById('driversList');
            driversList.innerHTML = `<div class="error" style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 8px; text-align: center;">${message}</div>`;
        }

        function logout() {
            sessionStorage.removeItem('rrts_user');
            window.location.href = 'dashboard.html';
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

    </script>
</body>
</html>
<!-- 
Version: v1.0.0 - RRTS Driver Management Portal
- v1.0.0: Initial driver management interface with full CRUD operations
- Features: Driver database management with weekly schedule configuration
- Real-time driver status tracking (available, busy, offline, time-off)
- Performance metrics and workload management with visual indicators
- Time off request management and approval workflow
- Driver assignment tracking with today's schedule overview
- Gender classification support for client requirements (is_male field)
- Workload preference settings (minimal/reduced/normal/maximum)
- Calendar integration support (Google, Outlook, Apple)
- Weekly availability editor with day-by-day hour configuration
- Driver activation/deactivation controls
- Contact management and communication tools
- Responsive design optimized for desktop and tablet use
- Ready for integration with drivers, driver_time_off, and appointments tables
- Mock data demonstrates complete driver management workflow
-->