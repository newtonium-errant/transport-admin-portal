<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ TEST MODE - Client Profile - RRTS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="../css/shared-styles.css" rel="stylesheet">
    <script src="js/components/TEST-navigation.js"></script><!-- Navigation Component -->
    <style>
        :root {
            --color-primary: #1B4332;
            --color-accent: #2D6A4F;
            --color-white: #FFFFFF;
            --color-black: #000000;
            --color-gray-light: #E5E5E5;
            --color-gray-dark: #333333;
        }

        body {
            background-color: #f8f9fa;
            padding-top: 130px; /* Account for TESTING banner (40px) + fixed header (70px) + spacing (20px) */
        }

        .test-warning-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10000;
            background: linear-gradient(135deg, #ff6b00 0%, #ff8c00 100%);
            color: white;
            padding: 10px 20px;
            text-align: center;
            font-weight: 600;
            font-size: 0.95em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* Header Styles */
        .app-header {
            position: fixed;
            top: 40px; /* Position below TESTING banner (40px) */
            left: 0;
            right: 0;
            height: 70px;
            background-color: var(--color-primary);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }

        .header-container {
            max-width: 100%;
            height: 100%;
            padding: 0 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 30px;
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: white;
            font-weight: 600;
            font-size: 1.3em;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .header-brand:hover {
            opacity: 0.9;
        }

        .brand-icon {
            font-size: 1.8em;
            line-height: 1;
        }

        .brand-text {
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .header-nav {
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-link:hover {
            background-color: var(--color-accent);
            color: white;
        }

        .nav-link.active {
            background-color: var(--color-accent);
            color: white;
            font-weight: 600;
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--color-accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9em;
        }

        .user-name {
            font-weight: 500;
            margin-right: 8px;
        }

        .user-role-badge {
            background-color: var(--color-accent);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: capitalize;
        }

        .logout-btn {
            background-color: transparent;
            color: white;
            border: 1px solid white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .logout-btn:hover {
            background-color: white;
            color: var(--color-primary);
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 8px;
        }

        .content-wrapper {
            margin-top: 20px;
        }

        .card-header {
            font-weight: 600;
        }

        .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .required-field::after {
            content: " *";
            color: #dc3545;
            font-weight: bold;
        }

        .read-only-field {
            background-color: #e9ecef !important;
            cursor: not-allowed;
        }

        .sticky-form-actions {
            position: sticky;
            bottom: 0;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }

        .section-card {
            border-left: 4px solid #1B4332;
            margin-bottom: 1.5rem;
        }

        .badge {
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
        }

        #loading-state {
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* Toast Notification Styles */
        .toast-container {
            position: fixed;
            top: 130px; /* Below TEST banner + header */
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            min-width: 300px;
            max-width: 400px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideInRight 0.3s ease-out;
            border-left: 4px solid;
        }

        .toast.toast-success {
            border-left-color: #28a745;
        }

        .toast.toast-error {
            border-left-color: #dc3545;
        }

        .toast.toast-warning {
            border-left-color: #ffc107;
        }

        .toast.toast-info {
            border-left-color: #17a2b8;
        }

        .toast-icon {
            font-size: 1.5em;
            flex-shrink: 0;
        }

        .toast-success .toast-icon {
            color: #28a745;
        }

        .toast-error .toast-icon {
            color: #dc3545;
        }

        .toast-warning .toast-icon {
            color: #ffc107;
        }

        .toast-info .toast-icon {
            color: #17a2b8;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
        }

        .toast-message {
            font-size: 0.9em;
            color: #666;
        }

        .toast-close {
            cursor: pointer;
            color: #999;
            font-size: 1.2em;
            line-height: 1;
            flex-shrink: 0;
            background: none;
            border: none;
            padding: 0;
            margin-left: auto;
        }

        .toast-close:hover {
            color: #333;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.hiding {
            animation: slideOutRight 0.3s ease-out forwards;
        }

        @keyframes slideOutRight {
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- TEST MODE WARNING BANNER -->
    <div class="test-warning-banner">
        <i class="bi bi-cone-striped me-2"></i>
        üß™ TEST MODE - Client Profile - Primary Clinic Feature Testing - Testing Branch Database
        <i class="bi bi-cone-striped ms-2"></i>
    </div>

    <!-- Header -->
    <header class="app-header">
        <div class="header-container">
            <!-- Brand -->
            <div class="header-brand" onclick="window.location.href='TEST-dashboard.html'">
                <span class="brand-icon">üöê</span>
                <span class="brand-text">RRTS</span>
            </div>

            <!-- Mobile Menu Toggle -->
            <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
                <i class="bi bi-list"></i>
            </button>

            <!-- Navigation -->
            <nav class="header-nav" id="mainNav">
                <!-- Navigation links will be populated by JavaScript based on RBAC -->
            </nav>

            <!-- User Section -->
            <div class="header-user">
                <div class="user-info">
                    <span class="user-avatar" id="userAvatar">--</span>
                    <span class="user-name" id="userName">User</span>
                    <span class="user-role-badge" id="userRoleBadge">Guest</span>
                </div>
                <button class="logout-btn" onclick="logout()" title="Logout">
                    <i class="bi bi-box-arrow-right"></i>
                    <span class="logout-text">Logout</span>
                </button>
            </div>
        </div>
    </header>

    <div class="container-fluid py-4 content-wrapper">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-1" id="page-title">
                    <span class="badge bg-warning text-dark me-2">TEST</span>
                    Client Profile
                </h1>
                <p class="text-muted mb-0" id="client-knumber">Loading...</p>
            </div>
            <div>
                <button type="button" class="btn btn-secondary me-2" id="btn-cancel">
                    <i class="bi bi-x-circle me-1"></i>
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" id="btn-save">
                    <i class="bi bi-check-circle me-1"></i>
                    Save Changes (TEST)
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="text-center py-5">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading client...</span>
            </div>
            <p class="mt-3 text-muted">Loading client profile...</p>
        </div>

        <!-- Error State -->
        <div id="error-state" class="alert alert-danger d-none" role="alert">
            <h4 class="alert-heading"><i class="bi bi-exclamation-triangle me-2"></i>Error Loading Client</h4>
            <p id="error-message"></p>
            <hr>
            <a href="TEST-clients-sl.html" class="btn btn-outline-danger">Return to Client List (TEST)</a>
        </div>

        <!-- Client Profile Form -->
        <form id="client-profile-form" class="d-none">

            <!-- Section 1: Basic Information -->
            <div class="card section-card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-person-fill me-2"></i>Basic Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="knumber" class="form-label required-field">K Number</label>
                            <input type="text" class="form-control" id="knumber" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="firstname" class="form-label required-field">First Name</label>
                            <input type="text" class="form-control" id="firstname" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="lastname" class="form-label required-field">Last Name</label>
                            <input type="text" class="form-control" id="lastname" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Created Date</label>
                            <input type="text" class="form-control read-only-field" id="created_at" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Contact Information -->
            <div class="card section-card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-telephone-fill me-2"></i>Contact Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="phone" class="form-label required-field">Phone Number</label>
                            <input type="tel" class="form-control" id="phone" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="email">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="emergency_contact_name" class="form-label">Emergency Contact Name</label>
                            <input type="text" class="form-control" id="emergency_contact_name">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="emergency_contact_number" class="form-label">Emergency Contact Number</label>
                            <input type="tel" class="form-control" id="emergency_contact_number">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 3: Primary Address -->
            <div class="card section-card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-geo-alt-fill me-2"></i>Primary Address</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="civicaddress" class="form-label required-field">Street Address</label>
                            <input type="text" class="form-control" id="civicaddress" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-5 mb-3">
                            <label for="city" class="form-label required-field">City</label>
                            <input type="text" class="form-control" id="city" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="prov" class="form-label required-field">Province</label>
                            <select class="form-select" id="prov" required>
                                <option value="">Select Province</option>
                                <option value="NS">Nova Scotia</option>
                                <option value="NB">New Brunswick</option>
                                <option value="PE">Prince Edward Island</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="postalcode" class="form-label required-field">Postal Code</label>
                            <input type="text" class="form-control" id="postalcode" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="mapaddress" class="form-label">Google Maps Address</label>
                            <input type="text" class="form-control" id="mapaddress">
                            <small class="form-text text-muted">Full address formatted for Google Maps (if different from civic address)</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 4: Secondary Address -->
            <div class="card section-card mb-4">
                <div class="card-header bg-secondary text-white" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#secondaryAddressCollapse">
                    <h5 class="mb-0 d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-house-fill me-2"></i>Secondary Address (Optional)</span>
                        <i class="bi bi-chevron-down"></i>
                    </h5>
                </div>
                <div id="secondaryAddressCollapse" class="collapse">
                    <div class="card-body">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="secondary_civic_address" class="form-label">Street Address</label>
                            <input type="text" class="form-control" id="secondary_civic_address">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-5 mb-3">
                            <label for="secondary_city" class="form-label">City</label>
                            <input type="text" class="form-control" id="secondary_city">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="secondary_province" class="form-label">Province</label>
                            <select class="form-select" id="secondary_province">
                                <option value="">Select Province</option>
                                <option value="NS">Nova Scotia</option>
                                <option value="NB">New Brunswick</option>
                                <option value="PE">Prince Edward Island</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="secondary_postal_code" class="form-label">Postal Code</label>
                            <input type="text" class="form-control" id="secondary_postal_code">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="secondary_address_notes" class="form-label">Secondary Address Notes</label>
                            <textarea class="form-control" id="secondary_address_notes" rows="3"></textarea>
                        </div>
                    </div>
                    </div>
                </div>
            </div>

            <!-- Section 5: Appointment Settings & Notes -->
            <div class="card section-card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-clock-fill me-2"></i>Appointment Settings & Notes</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="primary_clinic_id" class="form-label">
                                Primary Clinic
                                <span class="badge bg-info text-dark ms-2">Primary Clinic Feature</span>
                            </label>
                            <select class="form-select" id="primary_clinic_id">
                                <option value="">No Primary Clinic</option>
                                <!-- Populated from /webhook/clinic-locations -->
                            </select>
                            <small class="form-text text-muted">Default clinic for new appointments</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="appointment_length" class="form-label">Default Appointment Length (minutes)</label>
                            <input type="number" class="form-control" id="appointment_length" min="15" step="15">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="notes" class="form-label">Client Notes</label>
                            <textarea class="form-control" id="notes" rows="4"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 6: System Information -->
            <div class="card section-card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-gear-fill me-2"></i>System Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="openphone_contact_id" class="form-label">OpenPhone Contact ID</label>
                            <input type="text" class="form-control read-only-field" id="openphone_contact_id" readonly>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="openphone_sync_status" class="form-label">Sync Status</label>
                            <div class="mt-2">
                                <span class="badge bg-secondary" id="openphone_sync_status_badge">Unknown</span>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="openphone_sync_date" class="form-label">Last Synced</label>
                            <input type="text" class="form-control read-only-field" id="openphone_sync_date" readonly>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Clinic Travel Times</label>
                            <textarea class="form-control read-only-field" id="clinic_travel_times" rows="3" readonly></textarea>
                            <small class="form-text text-muted">Pre-calculated travel times to each clinic (JSONB data)</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions (Sticky Footer) -->
            <div class="sticky-form-actions bg-white border-top p-3 mt-4">
                <div class="container-fluid">
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" id="btn-cancel-bottom">
                            <i class="bi bi-x-circle me-1"></i>
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" id="btn-save-bottom">
                            <i class="bi bi-check-circle me-1"></i>
                            Save Changes (TEST)
                        </button>
                    </div>
                </div>
            </div>

        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth/TEST-jwt-auth.js"></script><!-- TEST version -->
    <script src="../js/auth/permissions.js"></script>
    <script src="js/pages/TEST-client-profile.js"></script>

    <!-- Navigation and logout handled by TEST-navigation.js -->

    <!-- Toast Notification Container -->
    <div class="toast-container" id="toastContainer"></div>

</body>
</html>
