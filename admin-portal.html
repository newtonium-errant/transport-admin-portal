<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rural Route Transportation Services - Admin Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 40px;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .hidden {
            display: none;
        }

        .client-status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .status-found {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-new {
            background: #cce5ff;
            color: #004085;
            border: 1px solid #b8daff;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .appointment-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .appointment-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
            transition: all 0.3s ease;
        }

        .appointment-item:hover {
            border-color: #3498db;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .appointment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .appointment-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-confirmed {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-new {
            background: #cce5ff;
            color: #004085;
        }

        .status-modified {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-deleted {
            background: #f8d7da;
            color: #721c24;
        }

        .appointment-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 10;
        }

        .deleted-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(108, 117, 125, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            font-size: 18px;
            z-index: 5;
        }

        .success-page {
            text-align: center;
            padding: 40px 20px;
        }

        .success-icon {
            font-size: 4em;
            color: #28a745;
            margin-bottom: 20px;
        }

        .success-title {
            font-size: 2em;
            color: #28a745;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .success-details {
            background: #f8fff9;
            border: 2px solid #28a745;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .success-summary {
            margin-bottom: 15px;
            font-size: 1.1em;
            color: #155724;
            font-weight: 600;
        }

        .operation-list {
            list-style: none;
            padding: 0;
        }

        .operation-list li {
            padding: 8px 0;
            border-bottom: 1px solid #c3e6cb;
            display: flex;
            align-items: center;
        }

        .operation-list li:last-child {
            border-bottom: none;
        }

        .operation-icon {
            margin-right: 10px;
            font-size: 1.2em;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 10px;
            }
            
            .content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Rural Route Transportation Services</h1>
            <p>Administrative Booking Portal</p>
        </div>

        <div class="content">
            <!-- Login Section -->
            <div id="loginSection">
                <div class="form-section">
                    <h3>Administrator Login</h3>
                    <div style="max-width: 400px; margin: 0 auto;">
                        <div class="form-group">
                            <label for="username">Username:</label>
                            <input type="text" id="username" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Password:</label>
                            <input type="password" id="password" required>
                        </div>
                        <div class="form-group" style="text-align: center; margin-top: 30px;">
                            <button type="button" class="btn btn-primary" onclick="login()" style="width: 100%; font-size: 18px; padding: 15px;">
                                Login
                            </button>
                        </div>
                        <div id="loginError" class="hidden"></div>
                    </div>
                </div>
            </div>

            <!-- Main Portal Section -->
            <div id="portalSection" class="hidden">
                <!-- K Number Lookup Section -->
                <div class="form-section">
                    <h3>Client Lookup</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="kNumber">K Number:</label>
                            <input type="text" id="kNumber" placeholder="Enter K Number (e.g., K7807878)" required>
                        </div>
                        <div class="form-group" style="display: flex; align-items: end;">
                            <button type="button" class="btn btn-primary" onclick="lookupClient()">Lookup Client</button>
                        </div>
                    </div>
                    <div id="clientStatus"></div>
                </div>

                <!-- Client Information Section -->
                <div id="clientSection" class="hidden">
                    <div class="form-section">
                        <h3>Client Information</h3>
                        
                        <!-- Basic Information -->
                        <div style="background: #ffffff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3498db;">
                            <h4 style="margin-bottom: 15px; color: #333;">Basic Information</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="firstName">First Name: <span style="color: red;">*</span></label>
                                    <input type="text" id="firstName" required>
                                </div>
                                <div class="form-group">
                                    <label for="lastName">Last Name: <span style="color: red;">*</span></label>
                                    <input type="text" id="lastName" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="phone">Phone: <span style="color: red;">*</span></label>
                                    <input type="tel" id="phone" required>
                                </div>
                                <div class="form-group">
                                    <label for="email">Email: <span style="color: red;">*</span></label>
                                    <input type="email" id="email" required>
                                </div>
                            </div>
                        </div>

                        <!-- Address Information -->
                        <div style="background: #ffffff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #28a745;">
                            <h4 style="margin-bottom: 15px; color: #333;">Address Information</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="address">Street Address: <span style="color: red;">*</span></label>
                                    <input type="text" id="address" required>
                                </div>
                                <div class="form-group">
                                    <label for="city">City: <span style="color: red;">*</span></label>
                                    <input type="text" id="city" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="province">Province: <span style="color: red;">*</span></label>
                                    <select id="province" required>
                                        <option value="">Select Province</option>
                                        <option value="AB">Alberta</option>
                                        <option value="BC">British Columbia</option>
                                        <option value="MB">Manitoba</option>
                                        <option value="NB">New Brunswick</option>
                                        <option value="NL">Newfoundland and Labrador</option>
                                        <option value="NS" selected>Nova Scotia</option>
                                        <option value="NT">Northwest Territories</option>
                                        <option value="NU">Nunavut</option>
                                        <option value="ON">Ontario</option>
                                        <option value="PE">Prince Edward Island</option>
                                        <option value="QC">Quebec</option>
                                        <option value="SK">Saskatchewan</option>
                                        <option value="YT">Yukon</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="postalCode">Postal Code: <span style="color: red;">*</span></label>
                                    <input type="text" id="postalCode" placeholder="A1A 1A1" pattern="[A-Za-z][0-9][A-Za-z] [0-9][A-Za-z][0-9]" required>
                                </div>
                            </div>
                        </div>

                        <!-- Emergency Contact -->
                        <div style="background: #ffffff; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #e74c3c;">
                            <h4 style="margin-bottom: 15px; color: #333;">Emergency Contact</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="emergencyContactName">Emergency Contact Name: <span style="color: red;">*</span></label>
                                    <input type="text" id="emergencyContactName" required>
                                </div>
                                <div class="form-group">
                                    <label for="emergencyContactNumber">Emergency Contact Number: <span style="color: red;">*</span></label>
                                    <input type="tel" id="emergencyContactNumber" required>
                                </div>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div style="background: #ffffff; padding: 20px; border-radius: 8px; border-left: 4px solid #f39c12;">
                            <div class="form-group">
                                <label for="notes">Notes or Special Requests:</label>
                                <textarea id="notes" placeholder="Any special requirements, medical needs, or notes about the client..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Appointments Section -->
                <div id="appointmentsSection" class="hidden">
                    <div class="form-section">
                        <h3>Appointments</h3>
                        <div class="appointment-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h4>Schedule Appointments</h4>
                                <button type="button" class="btn btn-success" onclick="addAppointment()">+ Add Appointment</button>
                            </div>
                            <div id="appointmentsList">
                                <!-- Appointments will be dynamically added here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Save Section -->
                <div id="saveSection" class="hidden">
                    <div class="form-section" style="text-align: center; padding-top: 20px; border-top: 2px solid #e9ecef;">
                        <button type="button" class="btn btn-primary" onclick="saveClientData()" style="font-size: 18px; padding: 15px 40px;">
                            Save Client & Appointments
                        </button>
                    </div>
                </div>
            </div>

            <!-- Success Section -->
            <div id="successSection" class="hidden">
                <div class="success-page">
                    <div class="success-icon">‚úÖ</div>
                    <div class="success-title">Successfully Saved!</div>
                    <div id="successMessage" style="font-size: 1.2em; margin-bottom: 20px; color: #333;"></div>
                    
                    <div class="success-details">
                        <div id="successDetails"></div>
                    </div>

                    <div style="margin-top: 30px;">
                        <button type="button" class="btn btn-primary" onclick="startNewBooking()" style="margin-right: 15px;">New Booking</button>
                        <button type="button" class="btn btn-secondary" onclick="returnToClient()">Back to Client</button>
                    </div>
                </div>
            </div>

            <!-- Loading indicator -->
            <div id="loadingIndicator" class="loading hidden">
                <p>Processing...</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentClient = null;
        let appointments = [];
        let appointmentCounter = 0;
        let isNewClient = false;

        // API endpoints - RRTS 4 Webhook URLs
        const API_ENDPOINTS = {
            LOGIN: 'https://webhook-processor-production-3bb8.up.railway.app/webhook/user-login',
            LOOKUP: 'https://webhook-processor-production-3bb8.up.railway.app/webhook/client-lookup',
            SAVE: 'https://webhook-processor-production-3bb8.up.railway.app/webhook/save-client'
        };

        // Frontend Appointment Management Fixes v3.2.0
        // Fix 1: Update client data collection to use civicAddress
        // Fix 2: Fix appointment modification tracking
        // Fix 3: Enable appointment deletion for existing appointments

        // Login function
        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!username || !password) {
                showLoginError('Please enter both username and password');
                return;
            }

            try {
                showLoading(true);

                const response = await fetch(API_ENDPOINTS.LOGIN, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Login successful
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('portalSection').classList.remove('hidden');
                    document.getElementById('kNumber').focus();
                } else {
                    showLoginError(result.message || 'Invalid credentials');
                }
            } catch (error) {
                console.error('Login error:', error);
                showLoginError('Login failed - please check your connection and try again');
            }
        }

        // Show login error
        function showLoginError(message) {
            showLoading(false);
            const errorDiv = document.getElementById('loginError');
            errorDiv.innerHTML = `<div class="error">${message}</div>`;
            errorDiv.classList.remove('hidden');
        }

        // 1. UPDATE CLIENT DATA COLLECTION FUNCTION
        function collectClientData() {
            return {
                kNumber: document.getElementById('kNumber').value.trim(),
                firstName: document.getElementById('firstName').value.trim(),
                lastName: document.getElementById('lastName').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                email: document.getElementById('email').value.trim(),
                civicAddress: document.getElementById('address').value.trim(), // ‚Üê FIXED: Now maps to civicAddress
                city: document.getElementById('city').value.trim(),
                province: document.getElementById('province').value.trim(),
                postalCode: document.getElementById('postalCode').value.trim(),
                emergencyContactName: document.getElementById('emergencyContactName').value.trim(),
                emergencyContactNumber: document.getElementById('emergencyContactNumber').value.trim(),
                notes: document.getElementById('notes').value.trim()
            };
        }

        // 2. FIXED APPOINTMENT UPDATE FUNCTION
        function updateAppointment(appointmentId, field, value) {
            console.log('üîÑ Updating appointment:', appointmentId, field, value);
            
            // Find the appointment in the appointments array
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                console.error('‚ùå Appointment not found:', appointmentId);
                return;
            }

            // Store original value for comparison
            const originalValue = appointment[field];
            
            // Update the appointment data
            appointment[field] = value;
            
            // For existing appointments, track modifications
            if (appointment.isExisting) {
                // Check if this is actually a change
                if (originalValue !== value) {
                    appointment.isModified = true;
                    appointment.modified_at = new Date().toISOString();
                    console.log('‚úèÔ∏è Marked existing appointment as modified:', appointmentId);
                    
                    // Update visual indicators immediately
                    updateAppointmentDisplay(appointmentId);
                }
            }
            
            // Mark as no longer a draft if all required fields are filled
            if (appointment.date && appointment.time && appointment.location) {
                appointment.isDraft = false;
            }
            
            console.log('üìù Updated appointment data:', appointment);
        }

        // 3. FIXED APPOINTMENT REMOVAL FUNCTION
        function removeAppointment(appointmentId) {
            console.log('üóëÔ∏è Remove appointment called for:', appointmentId);
            
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                console.error('‚ùå Appointment not found for removal:', appointmentId);
                return;
            }

            if (appointment.isExisting) {
                // For existing appointments, mark as deleted instead of removing
                appointment.isDeleted = true;
                appointment.deleted_at = new Date().toISOString();
                console.log('üóëÔ∏è Marked existing appointment as deleted:', appointmentId);
                
                // Update the visual display to show deleted state
                updateAppointmentDisplay(appointmentId);
            } else {
                // For new appointments, actually remove from array
                const index = appointments.findIndex(apt => apt.id === appointmentId);
                if (index !== -1) {
                    appointments.splice(index, 1);
                    console.log('‚ùå Removed new appointment from array:', appointmentId);
                    
                    // Remove from DOM
                    const appointmentElement = document.getElementById(`appointment-${appointmentId}`);
                    if (appointmentElement) {
                        appointmentElement.remove();
                    }
                }
            }
        }

        // 4. NEW FUNCTION: UNDELETE APPOINTMENT
        function undeleteAppointment(appointmentId) {
            console.log('‚Ü∂ Undelete appointment called for:', appointmentId);
            
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (appointment && appointment.isDeleted) {
                appointment.isDeleted = false;
                delete appointment.deleted_at;
                console.log('‚Ü∂ Restored appointment:', appointmentId);
                
                // Update the visual display
                updateAppointmentDisplay(appointmentId);
            }
        }

        // 5. ENHANCED APPOINTMENT DISPLAY UPDATE
        function updateAppointmentDisplay(appointmentId) {
            const appointment = appointments.find(apt => apt.id === appointmentId);
            if (!appointment) return;

            const appointmentElement = document.getElementById(`appointment-${appointmentId}`);
            if (!appointmentElement) return;

            // Update status badge
            const statusElement = appointmentElement.querySelector('.appointment-status');
            if (statusElement) {
                let statusClass = 'status-new';
                let statusText = 'üÜï New';
                
                if (appointment.isDeleted) {
                    statusClass = 'status-deleted';
                    statusText = 'üóëÔ∏è Deleted';
                } else if (appointment.isModified) {
                    statusClass = 'status-modified';
                    statusText = '‚úèÔ∏è Modified';
                } else if (appointment.isExisting) {
                    statusClass = appointment.appointmentStatus === 'confirmed' ? 'status-confirmed' : 'status-pending';
                    statusText = appointment.appointmentStatus === 'confirmed' ? '‚úÖ Confirmed' : '‚è≥ Pending';
                }
                
                statusElement.className = `appointment-status ${statusClass}`;
                statusElement.textContent = statusText;
            }

            // Update action buttons
            const actionsElement = appointmentElement.querySelector('.appointment-actions');
            if (actionsElement) {
                if (appointment.isDeleted) {
                    actionsElement.innerHTML = `<button type="button" class="btn btn-success" onclick="undeleteAppointment('${appointment.id}')" title="Restore appointment">‚Ü∂</button>`;
                } else {
                    actionsElement.innerHTML = `<button type="button" class="btn btn-danger" onclick="removeAppointment('${appointment.id}')" title="Remove appointment">√ó</button>`;
                }
            }

            // Enable/disable form fields based on deleted status
            const inputs = appointmentElement.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.disabled = appointment.isDeleted;
            });

            // Add/remove deleted overlay
            let overlay = appointmentElement.querySelector('.deleted-overlay');
            if (appointment.isDeleted && !overlay) {
                overlay = document.createElement('div');
                overlay.className = 'deleted-overlay';
                overlay.textContent = 'DELETED';
                appointmentElement.style.position = 'relative';
                appointmentElement.appendChild(overlay);
            } else if (!appointment.isDeleted && overlay) {
                overlay.remove();
            }
        }

        // 6. ENHANCED LOAD CLIENT DATA FUNCTION WITH APPOINTMENT SORTING
        function loadClientData(clientData, existingAppointments = []) {
            isNewClient = false;
            currentClient = clientData;

            // Populate client form fields
            document.getElementById('firstName').value = clientData.firstName || '';
            document.getElementById('lastName').value = clientData.lastName || '';
            document.getElementById('phone').value = clientData.phone || '';
            document.getElementById('email').value = clientData.email || '';
            document.getElementById('address').value = clientData.address || ''; // Maps to civicAddress in backend
            document.getElementById('city').value = clientData.city || '';
            document.getElementById('province').value = clientData.province || '';
            document.getElementById('postalCode').value = clientData.postalCode || '';
            document.getElementById('emergencyContactName').value = clientData.emergencyContactName || '';
            document.getElementById('emergencyContactNumber').value = clientData.emergencyContactNumber || '';
            document.getElementById('notes').value = clientData.notes || '';

            // Load existing appointments
            appointments = [];
            appointmentCounter = 0;
            
            if (existingAppointments && existingAppointments.length > 0) {
                console.log('üìÖ Loading existing appointments:', existingAppointments);
                
                // Sort appointments by date (soonest first)
                const sortedAppointments = existingAppointments.sort((a, b) => {
                    const dateA = new Date(a.date + ' ' + a.time);
                    const dateB = new Date(b.date + ' ' + b.time);
                    return dateA - dateB;
                });
                
                sortedAppointments.forEach(apt => {
                    const appointment = {
                        id: apt.id,
                        date: apt.date,
                        time: apt.time,
                        location: apt.location || apt.locationname,
                        notes: apt.notes || '',
                        isExisting: true,
                        isModified: false,
                        isDeleted: false,
                        originalId: apt.id,
                        appointmentStatus: apt.appointmentstatus || 'pending'
                    };
                    
                    appointments.push(appointment);
                    appointmentCounter = Math.max(appointmentCounter, parseInt(apt.id.split('-').pop()) || 0);
                });
                
                // Display the appointments
                displayAppointments();
            }

            // Show the form sections
            document.getElementById('clientSection').classList.remove('hidden');
            document.getElementById('appointmentsSection').classList.remove('hidden');
            document.getElementById('saveSection').classList.remove('hidden');
        }

        // 7. ENHANCED SAVE PREPARATION FUNCTION
        function prepareAppointmentOperations() {
            const operations = {
                newCount: 0,
                modifiedCount: 0,
                deletedCount: 0,
                totalCount: 0
            };

            const validAppointments = appointments.filter(apt => {
                // Count all appointments (new, modified, deleted)
                if (apt.isDeleted) {
                    operations.deletedCount++;
                } else if (apt.isExisting && apt.isModified) {
                    operations.modifiedCount++;
                } else if (!apt.isExisting && !apt.isDraft) {
                    operations.newCount++;
                }
                
                operations.totalCount++;
                
                // Include all appointments except incomplete drafts
                return !apt.isDraft || (apt.date && apt.time && apt.location);
            });

            console.log('üìä Appointment operations summary:', operations);
            console.log('üìù Valid appointments to process:', validAppointments);

            return {
                appointments: validAppointments,
                operations: operations
            };
        }

        // Client lookup function
        async function lookupClient() {
            const kNumber = document.getElementById('kNumber').value.trim();
            
            if (!kNumber) {
                showError('Please enter a K Number');
                return;
            }

            try {
                showLoading(true);
                
                const response = await fetch(API_ENDPOINTS.LOOKUP, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ kNumber: kNumber })
                });

                const result = await response.json();
                console.log('Client lookup result:', result);

                if (result.found) {
                    // Existing client found
                    loadClientData(result.clientData, result.appointments || []);
                    
                    // Count future appointments for display
                    const futureAppointments = (result.appointments || []).filter(apt => {
                        const appointmentDate = new Date(apt.date + ' ' + apt.time);
                        return appointmentDate > new Date();
                    });
                    
                    showClientStatus(`Client Found: ${result.clientData.firstName} ${result.clientData.lastName}${futureAppointments.length > 0 ? ` (${futureAppointments.length} future appointments)` : ''}`, 'found');
                } else {
                    // New client
                    setupNewClient(kNumber);
                    showClientStatus('New Client - Please fill out all information', 'new');
                }
            } catch (error) {
                console.error('Lookup error:', error);
                showError('Client lookup failed - please try again');
            }
        }

        // Setup for new client
        function setupNewClient(kNumber) {
            isNewClient = true;
            currentClient = null;
            appointments = [];
            appointmentCounter = 0;

            // Clear all form fields
            clearClientForm();
            
            // Set the K Number (make it editable for new clients)
            document.getElementById('kNumber').value = kNumber;
            
            // Show the form sections
            document.getElementById('clientSection').classList.remove('hidden');
            document.getElementById('appointmentsSection').classList.remove('hidden');
            document.getElementById('saveSection').classList.remove('hidden');
        }

        // Clear client form
        function clearClientForm() {
            const formFields = ['firstName', 'lastName', 'phone', 'email', 'address', 'city', 'province', 'postalCode', 'emergencyContactName', 'emergencyContactNumber', 'notes'];
            formFields.forEach(field => {
                document.getElementById(field).value = '';
            });
            document.getElementById('province').value = 'NS'; // Default to Nova Scotia
        }

        // Add new appointment
        function addAppointment() {
            appointmentCounter++;
            const appointmentId = `appointment-${Date.now()}-${appointmentCounter}`;
            
            const appointment = {
                id: appointmentId,
                date: '',
                time: '',
                location: '',
                notes: '',
                isExisting: false,
                isModified: false,
                isDeleted: false,
                isDraft: true
            };

            appointments.push(appointment);
            displayAppointments();
            
            // Focus on the date field of the new appointment
            setTimeout(() => {
                const dateInput = document.getElementById(`date-${appointmentId}`);
                if (dateInput) {
                    dateInput.focus();
                }
            }, 100);
        }

        // Display all appointments
        function displayAppointments() {
            const appointmentsList = document.getElementById('appointmentsList');
            appointmentsList.innerHTML = '';

            if (appointments.length === 0) {
                appointmentsList.innerHTML = '<p style="text-align: center; color: #666; font-style: italic; padding: 20px;">No appointments scheduled. Click "Add Appointment" to begin.</p>';
                return;
            }

            appointments.forEach(appointment => {
                const appointmentDiv = document.createElement('div');
                appointmentDiv.className = `appointment-item ${appointment.isExisting ? 'existing' : 'new'}${appointment.isModified ? ' modified' : ''}${appointment.isDeleted ? ' deleted' : ''}`;
                appointmentDiv.id = `appointment-${appointment.id}`;

                // Get status display
                let statusClass = 'status-new';
                let statusText = 'üÜï New';
                
                if (appointment.isDeleted) {
                    statusClass = 'status-deleted';
                    statusText = 'üóëÔ∏è Deleted';
                } else if (appointment.isModified) {
                    statusClass = 'status-modified';
                    statusText = '‚úèÔ∏è Modified';
                } else if (appointment.isExisting) {
                    statusClass = appointment.appointmentStatus === 'confirmed' ? 'status-confirmed' : 'status-pending';
                    statusText = appointment.appointmentStatus === 'confirmed' ? '‚úÖ Confirmed' : '‚è≥ Pending';
                }

                appointmentDiv.innerHTML = `
                    <div class="appointment-header">
                        <span class="appointment-status ${statusClass}">${statusText}</span>
                        <div class="appointment-actions">
                            ${appointment.isDeleted ? 
                                `<button type="button" class="btn btn-success" onclick="undeleteAppointment('${appointment.id}')" title="Restore appointment">‚Ü∂</button>` :
                                `<button type="button" class="btn btn-danger" onclick="removeAppointment('${appointment.id}')" title="Remove appointment">√ó</button>`
                            }
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Date:</label>
                            <input type="date" 
                                   id="date-${appointment.id}" 
                                   value="${appointment.date}" 
                                   min="${new Date().toISOString().split('T')[0]}"
                                   onchange="updateAppointment('${appointment.id}', 'date', this.value)"
                                   ${appointment.isDeleted ? 'disabled' : ''}>
                        </div>
                        <div class="form-group">
                            <label>Time:</label>
                            <input type="time" 
                                   id="time-${appointment.id}" 
                                   value="${appointment.time}" 
                                   onchange="updateAppointment('${appointment.id}', 'time', this.value)"
                                   ${appointment.isDeleted ? 'disabled' : ''}>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Location:</label>
                            <select id="location-${appointment.id}" 
                                    onchange="updateAppointment('${appointment.id}', 'location', this.value)"
                                    ${appointment.isDeleted ? 'disabled' : ''}>
                                <option value="">Select Location</option>
                                <option value="NuVista Greenwood" ${appointment.location === 'NuVista Greenwood' ? 'selected' : ''}>NuVista Greenwood</option>
                                <option value="NuVista New Minas" ${appointment.location === 'NuVista New Minas' ? 'selected' : ''}>NuVista New Minas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Notes:</label>
                            <input type="text" 
                                   id="notes-${appointment.id}" 
                                   value="${appointment.notes}" 
                                   placeholder="Optional notes..."
                                   onchange="updateAppointment('${appointment.id}', 'notes', this.value)"
                                   ${appointment.isDeleted ? 'disabled' : ''}>
                        </div>
                    </div>
                `;

                // Add deleted overlay if needed
                if (appointment.isDeleted) {
                    const overlay = document.createElement('div');
                    overlay.className = 'deleted-overlay';
                    overlay.textContent = 'DELETED';
                    appointmentDiv.style.position = 'relative';
                    appointmentDiv.appendChild(overlay);
                }

                appointmentsList.appendChild(appointmentDiv);
            });
        }

        // Save client data and appointments
        async function saveClientData() {
            if (!validateRequiredFields()) {
                return;
            }

            try {
                showLoading(true);

                const clientData = collectClientData();
                const { appointments: validAppointments, operations } = prepareAppointmentOperations();

                const payload = {
                    kNumber: clientData.kNumber,
                    clientData: clientData,
                    appointments: validAppointments,
                    isNewClient: isNewClient,
                    submittedBy: 'admin',
                    submittedAt: new Date().toISOString()
                };

                console.log('Saving payload:', payload);

                const response = await fetch(API_ENDPOINTS.SAVE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                console.log('Save result:', result);

                if (result.success) {
                    showSuccessPage(result, {
                        newCount: operations.newCount,
                        modifiedCount: operations.modifiedCount,
                        deletedCount: operations.deletedCount,
                        totalCount: validAppointments.length,
                        clientName: `${clientData.firstName} ${clientData.lastName}`
                    });
                } else {
                    showError(result.message || 'Save failed - please try again');
                }

            } catch (error) {
                console.error('üí• Save error:', error);
                showError('Save failed - please check your connection and try again');
            }
        }

        // Validate required fields
        function validateRequiredFields() {
            const requiredFields = [
                { id: 'firstName', name: 'First Name' },
                { id: 'lastName', name: 'Last Name' },
                { id: 'phone', name: 'Phone' },
                { id: 'email', name: 'Email' },
                { id: 'address', name: 'Street Address' },
                { id: 'city', name: 'City' },
                { id: 'province', name: 'Province' },
                { id: 'postalCode', name: 'Postal Code' },
                { id: 'emergencyContactName', name: 'Emergency Contact Name' },
                { id: 'emergencyContactNumber', name: 'Emergency Contact Number' }
            ];

            for (let field of requiredFields) {
                const element = document.getElementById(field.id);
                if (!element.value.trim()) {
                    showError(`Please fill in the ${field.name} field`);
                    element.focus();
                    return false;
                }
            }

            // Check for at least one valid appointment
            const validAppointments = appointments.filter(apt => 
                !apt.isDraft && !apt.isDeleted && apt.date && apt.time && apt.location
            );

            if (validAppointments.length === 0) {
                showError('Please add at least one complete appointment');
                return false;
            }

            return true;
        }

        // Show success page with detailed information
        function showSuccessPage(result, operations) {
            document.getElementById('portalSection').classList.add('hidden');
            document.getElementById('successSection').classList.remove('hidden');

            // Set success message
            const successMessage = `Successfully saved ${operations.clientName}${isNewClient ? ' (new client)' : ' (existing client)'}`;
            document.getElementById('successMessage').textContent = successMessage;

            // Build detailed operations list
            const operationsList = [];
            if (operations.newCount > 0) {
                operationsList.push(`<li><span class="operation-icon">‚ûï</span>Added ${operations.newCount} new appointment${operations.newCount === 1 ? '' : 's'}</li>`);
            }
            if (operations.modifiedCount > 0) {
                operationsList.push(`<li><span class="operation-icon">‚úèÔ∏è</span>Modified ${operations.modifiedCount} existing appointment${operations.modifiedCount === 1 ? '' : 's'}</li>`);
            }
            if (operations.deletedCount > 0) {
                operationsList.push(`<li><span class="operation-icon">üóëÔ∏è</span>Deleted ${operations.deletedCount} appointment${operations.deletedCount === 1 ? '' : 's'}</li>`);
            }

            const successDetails = `
                <div class="success-summary">
                    <strong>Operations Completed:</strong>
                </div>
                <ul class="operation-list">
                    ${operationsList.join('')}
                </ul>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #c3e6cb; color: #155724; font-size: 0.9em;">
                    <strong>K Number:</strong> ${currentClient?.kNumber || document.getElementById('kNumber').value}<br>
                    <strong>Time:</strong> ${new Date().toLocaleString()}<br>
                    ${result.message ? `<strong>System:</strong> ${result.message}` : ''}
                </div>
            `;

            document.getElementById('successDetails').innerHTML = successDetails;
        }

        // Start new booking
        function startNewBooking() {
            // Reset all state
            currentClient = null;
            isNewClient = false;
            appointments = [];
            appointmentCounter = 0;

            // Clear forms
            document.getElementById('kNumber').value = '';
            clearClientForm();

            // Hide sections
            document.getElementById('clientSection').classList.add('hidden');
            document.getElementById('appointmentsSection').classList.add('hidden');
            document.getElementById('saveSection').classList.add('hidden');
            document.getElementById('clientStatus').innerHTML = '';

            // Show portal section and hide success
            document.getElementById('successSection').classList.add('hidden');
            document.getElementById('portalSection').classList.remove('hidden');

            // Focus on K Number field
            document.getElementById('kNumber').focus();
        }

        // Return to client (for modifications)
        function returnToClient() {
            document.getElementById('successSection').classList.add('hidden');
            document.getElementById('portalSection').classList.remove('hidden');
        }

        // Utility functions
        function showLoading(show) {
            const indicator = document.getElementById('loadingIndicator');
            if (show) {
                indicator.classList.remove('hidden');
            } else {
                indicator.classList.add('hidden');
            }
        }

        function showError(message) {
            showLoading(false);
            const statusDiv = document.getElementById('clientStatus');
            statusDiv.innerHTML = `<div class="error">${message}</div>`;
        }

        function showClientStatus(message, type) {
            showLoading(false);
            const statusDiv = document.getElementById('clientStatus');
            statusDiv.innerHTML = `<div class="client-status status-${type}">${message}</div>`;
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Rural Route Transportation Admin Portal Loaded');
            
            // Focus on username field initially
            document.getElementById('username').focus();
            
            // Handle Enter key for login
            document.getElementById('username').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('password').focus();
                }
            });
            
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
        });

        console.log('‚úÖ Frontend appointment management fixes v3.2.3 loaded');

        // Version: v3.2.0 - Frontend appointment management fixes with RRTS 4 integration
        // - v3.0.0: Original frontend functions
        // - v3.1.0: Added basic appointment tracking  
        // - v3.2.0: Fixed civicAddress mapping, appointment modification tracking, deletion functionality, 
        //           simplified location options, added appointment sorting, updated to RRTS 4 login system,
        //           improved future appointment filtering, and enhanced visual modification indicators

    </script>
</body>
</html>
<!-- v3.2.3 -->
