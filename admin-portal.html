// Frontend Appointment Management Fixes v3.2.0
// Fix 1: Update client data collection to use civicAddress
// Fix 2: Fix appointment modification tracking
// Fix 3: Enable appointment deletion for existing appointments

// 1. UPDATE CLIENT DATA COLLECTION FUNCTION
function collectClientData() {
    return {
        kNumber: document.getElementById('kNumber').value.trim(),
        firstName: document.getElementById('firstName').value.trim(),
        lastName: document.getElementById('lastName').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        email: document.getElementById('email').value.trim(),
        civicAddress: document.getElementById('address').value.trim(), // â† FIXED: Now maps to civicAddress
        city: document.getElementById('city').value.trim(),
        province: document.getElementById('province').value.trim(),
        postalCode: document.getElementById('postalCode').value.trim(),
        emergencyContactName: document.getElementById('emergencyContactName').value.trim(),
        emergencyContactNumber: document.getElementById('emergencyContactNumber').value.trim(),
        notes: document.getElementById('notes').value.trim()
    };
}

// 2. FIXED APPOINTMENT UPDATE FUNCTION
function updateAppointment(appointmentId, field, value) {
    console.log('ğŸ”„ Updating appointment:', appointmentId, field, value);
    
    // Find the appointment in the appointments array
    const appointment = appointments.find(apt => apt.id === appointmentId);
    if (!appointment) {
        console.error('âŒ Appointment not found:', appointmentId);
        return;
    }

    // Store original value for comparison
    const originalValue = appointment[field];
    
    // Update the appointment data
    appointment[field] = value;
    
    // For existing appointments, track modifications
    if (appointment.isExisting) {
        // Check if this is actually a change
        if (originalValue !== value) {
            appointment.isModified = true;
            appointment.modified_at = new Date().toISOString();
            console.log('âœï¸ Marked existing appointment as modified:', appointmentId);
        }
    }
    
    // Special handling for date/time changes
    if (field === 'date' || field === 'time') {
        // Update visual indicators immediately
        updateAppointmentDisplay(appointmentId);
    }
    
    console.log('ğŸ“ Updated appointment data:', appointment);
}

// 3. FIXED APPOINTMENT REMOVAL FUNCTION
function removeAppointment(appointmentId) {
    console.log('ğŸ—‘ï¸ Remove appointment called for:', appointmentId);
    
    const appointment = appointments.find(apt => apt.id === appointmentId);
    if (!appointment) {
        console.error('âŒ Appointment not found for removal:', appointmentId);
        return;
    }

    if (appointment.isExisting) {
        // For existing appointments, mark as deleted instead of removing
        appointment.isDeleted = true;
        appointment.deleted_at = new Date().toISOString();
        console.log('ğŸ—‘ï¸ Marked existing appointment as deleted:', appointmentId);
        
        // Update the visual display to show deleted state
        updateAppointmentDisplay(appointmentId);
    } else {
        // For new appointments, actually remove from array
        const index = appointments.findIndex(apt => apt.id === appointmentId);
        if (index !== -1) {
            appointments.splice(index, 1);
            console.log('âŒ Removed new appointment from array:', appointmentId);
            
            // Remove from DOM
            const appointmentElement = document.getElementById(`appointment-${appointmentId}`);
            if (appointmentElement) {
                appointmentElement.remove();
            }
        }
    }
}

// 4. NEW FUNCTION: UNDELETE APPOINTMENT
function undeleteAppointment(appointmentId) {
    console.log('â†¶ Undelete appointment called for:', appointmentId);
    
    const appointment = appointments.find(apt => apt.id === appointmentId);
    if (appointment && appointment.isDeleted) {
        appointment.isDeleted = false;
        delete appointment.deleted_at;
        console.log('â†¶ Restored appointment:', appointmentId);
        
        // Update the visual display
        updateAppointmentDisplay(appointmentId);
    }
}

// 5. ENHANCED APPOINTMENT DISPLAY UPDATE
function updateAppointmentDisplay(appointmentId) {
    const appointment = appointments.find(apt => apt.id === appointmentId);
    if (!appointment) return;

    const appointmentElement = document.getElementById(`appointment-${appointmentId}`);
    if (!appointmentElement) return;

    // Update status badge
    const statusElement = appointmentElement.querySelector('.appointment-status');
    if (statusElement) {
        let statusClass = 'status-new';
        let statusText = 'ğŸ†• New';
        
        if (appointment.isDeleted) {
            statusClass = 'status-deleted';
            statusText = 'ğŸ—‘ï¸ Deleted';
        } else if (appointment.isModified) {
            statusClass = 'status-modified';
            statusText = 'âœï¸ Modified';
        } else if (appointment.isExisting) {
            statusClass = appointment.appointmentStatus === 'confirmed' ? 'status-confirmed' : 'status-pending';
            statusText = appointment.appointmentStatus === 'confirmed' ? 'âœ… Confirmed' : 'â³ Pending';
        }
        
        statusElement.className = `appointment-status ${statusClass}`;
        statusElement.textContent = statusText;
    }

    // Update action buttons
    const actionsElement = appointmentElement.querySelector('.appointment-actions');
    if (actionsElement) {
        if (appointment.isDeleted) {
            actionsElement.innerHTML = `<button type="button" class="btn btn-success" onclick="undeleteAppointment('${appointment.id}')" title="Restore appointment">â†¶</button>`;
        } else {
            actionsElement.innerHTML = `<button type="button" class="btn btn-danger" onclick="removeAppointment('${appointment.id}')" title="Remove appointment">Ã—</button>`;
        }
    }

    // Enable/disable form fields based on deleted status
    const inputs = appointmentElement.querySelectorAll('input, select');
    inputs.forEach(input => {
        input.disabled = appointment.isDeleted;
    });

    // Add/remove deleted overlay
    let overlay = appointmentElement.querySelector('.deleted-overlay');
    if (appointment.isDeleted && !overlay) {
        overlay = document.createElement('div');
        overlay.className = 'deleted-overlay';
        overlay.textContent = 'DELETED';
        appointmentElement.style.position = 'relative';
        appointmentElement.appendChild(overlay);
    } else if (!appointment.isDeleted && overlay) {
        overlay.remove();
    }
}

// 6. ENHANCED LOAD CLIENT DATA FUNCTION
function loadClientData(clientData, existingAppointments = []) {
    isNewClient = false;
    currentClient = clientData;

    // Populate client form fields
    document.getElementById('firstName').value = clientData.firstName || '';
    document.getElementById('lastName').value = clientData.lastName || '';
    document.getElementById('phone').value = clientData.phone || '';
    document.getElementById('email').value = clientData.email || '';
    document.getElementById('address').value = clientData.address || ''; // Maps to civicAddress in backend
    document.getElementById('city').value = clientData.city || '';
    document.getElementById('province').value = clientData.province || '';
    document.getElementById('postalCode').value = clientData.postalCode || '';
    document.getElementById('emergencyContactName').value = clientData.emergencyContactName || '';
    document.getElementById('emergencyContactNumber').value = clientData.emergencyContactNumber || '';
    document.getElementById('notes').value = clientData.notes || '';

    // Load existing appointments
    appointments = [];
    appointmentCounter = 0;
    
    if (existingAppointments && existingAppointments.length > 0) {
        console.log('ğŸ“… Loading existing appointments:', existingAppointments);
        
        existingAppointments.forEach(apt => {
            const appointment = {
                id: apt.id,
                date: apt.date,
                time: apt.time,
                location: apt.location || apt.locationname,
                notes: apt.notes || '',
                isExisting: true,
                isModified: false,
                isDeleted: false,
                originalId: apt.id,
                appointmentStatus: apt.appointmentstatus || 'pending'
            };
            
            appointments.push(appointment);
            appointmentCounter = Math.max(appointmentCounter, parseInt(apt.id.split('-').pop()) || 0);
        });
        
        // Display the appointments
        displayAppointments();
    }

    // Show the form sections
    document.getElementById('clientSection').classList.remove('hidden');
    document.getElementById('appointmentsSection').classList.remove('hidden');
    document.getElementById('saveSection').classList.remove('hidden');
}

// 7. ENHANCED SAVE PREPARATION FUNCTION
function prepareAppointmentOperations() {
    const operations = {
        newCount: 0,
        modifiedCount: 0,
        deletedCount: 0,
        totalCount: 0
    };

    const validAppointments = appointments.filter(apt => {
        // Count all appointments (new, modified, deleted)
        if (apt.isDeleted) {
            operations.deletedCount++;
        } else if (apt.isExisting && apt.isModified) {
            operations.modifiedCount++;
        } else if (!apt.isExisting && !apt.isDraft) {
            operations.newCount++;
        }
        
        operations.totalCount++;
        
        // Include all appointments except incomplete drafts
        return !apt.isDraft || (apt.date && apt.time && apt.location);
    });

    console.log('ğŸ“Š Appointment operations summary:', operations);
    console.log('ğŸ“ Valid appointments to process:', validAppointments);

    return {
        appointments: validAppointments,
        operations: operations
    };
}

console.log('âœ… Frontend appointment management fixes v3.2.0 loaded');

// Version: v3.2.0 - Frontend appointment management fixes
// - v3.0.0: Original frontend functions
// - v3.1.0: Added basic appointment tracking
// - v3.2.0: Fixed civicAddress mapping, appointment modification tracking, and deletion functionality
