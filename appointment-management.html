<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appointment Management - RRTS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .header h1 {
            font-size: 1.8em;
            font-weight: 300;
            color: white;
            margin: 0;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 0.9em;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: background-color 0.3s ease;
        }

        .nav-links a:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .nav-links a.active {
            background-color: rgba(255,255,255,0.2);
        }

        .container {
            margin-top: 100px;
            padding: 2rem;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .card-header {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border-radius: 12px 12px 0 0 !important;
            padding: 1rem 1.5rem;
            border: none;
        }

        .card-header h5 {
            margin: 0;
            font-weight: 600;
        }

        .card-body {
            padding: 1.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-outline-secondary {
            border-color: #e9ecef;
            color: #6c757d;
            border-radius: 8px;
            padding: 12px 30px;
            font-weight: 600;
        }

        .btn-outline-secondary:hover {
            background-color: #3498db;
            border-color: #3498db;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            font-weight: 600;
        }

        .btn-warning {
            background: #fd7e14;
            border: none;
            border-radius: 8px;
            color: white;
            padding: 12px 30px;
            font-weight: 600;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .table {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .table th {
            background-color: #3498db;
            color: white;
            font-weight: 600;
            border: none;
            padding: 1rem;
        }

        .table td {
            padding: 1rem;
            vertical-align: middle;
            border-bottom: 1px solid #e9ecef;
        }

        .table tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }

        .appointment-item {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .appointment-item h6 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .appointment-meta {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .appointment-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: capitalize;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-confirmed {
            background: #d4edda;
            color: #155724;
        }

        .status-completed, .status-complete {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .error-message {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            animation: slideDown 0.5s ease;
        }

        .success-message {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .modal-content {
            border-radius: 12px;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .form-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .readonly-field {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
                position: relative;
            }

            .container {
                margin-top: 20px;
                padding: 1rem;
            }

            .nav-links {
                width: 100%;
                justify-content: center;
            }

            .table-responsive {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header matching add-appointments.html -->
    <div class="header">
        <h1>RRTS Dashboard</h1>
        <div class="header-info">
            <span id="currentDateTime"></span>
            <span>â€¢</span>
            <span id="welcomeUser">Welcome, Admin</span>
        </div>
        <div class="nav-links">
            <a href="dashboard.html">Dashboard</a>
            <a href="client-management.html">Clients</a>
            <a href="appointment-management.html" class="active">Appointments</a>
            <a href="add-appointments.html">Add Appointments</a>
            <a href="operations.html">Operations</a>
            <a href="driver-management.html">Drivers</a>
            <a href="admin.html">Admin</a>
            <a href="#" onclick="logout()">Logout</a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>
                        <i class="bi bi-calendar-check me-2"></i>
                        Appointment Management
                    </h2>
                </div>

                <!-- Filters Section -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-funnel me-2"></i>
                            Filter Appointments
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="statusFilter" class="form-label">Status:</label>
                                <select class="form-select" id="statusFilter" onchange="filterAppointments()">
                                    <option value="">All Statuses</option>
                                    <option value="pending">Pending</option>
                                    <option value="confirmed">Confirmed</option>
                                    <option value="completed">Completed</option>
                                    <option value="complete">Complete</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="clientFilter" class="form-label">Search Client:</label>
                                <input type="text" class="form-control" id="clientFilter" placeholder="Enter client name or K number" oninput="filterAppointments()">
                            </div>
                            <div class="col-md-3">
                                <label for="dateFilter" class="form-label">Filter by Date:</label>
                                <input type="date" class="form-control" id="dateFilter" onchange="filterAppointments()">
                            </div>
                            <div class="col-md-3">
                                <label for="futureOnlyFilter" class="form-label">Time Filter:</label>
                                <select class="form-select" id="futureOnlyFilter" onchange="filterAppointments()">
                                    <option value="">All Appointments</option>
                                    <option value="future">Future Only</option>
                                    <option value="past">Past Only</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Appointments List -->
                <div id="allAppointmentsList">
                    <div class="loading">Loading appointments...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Appointment Modal -->
    <div class="modal fade" id="editAppointmentModal" tabindex="-1" aria-labelledby="editAppointmentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editAppointmentModalLabel">
                        <i class="bi bi-pencil-square me-2"></i>
                        Edit Appointment
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editAppointmentForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editTableId" class="form-label">Table ID</label>
                                    <input type="text" class="form-control readonly-field" id="editTableId" readonly>
                                    <small class="text-muted">This ID cannot be changed</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editKNumber" class="form-label">K Number</label>
                                    <input type="text" class="form-control" id="editKNumber">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editAppointmentTime" class="form-label">Appointment Date & Time</label>
                                    <input type="datetime-local" class="form-control" id="editAppointmentTime">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editPickupTime" class="form-label">Pickup Time</label>
                                    <input type="datetime-local" class="form-control" id="editPickupTime">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editLocationName" class="form-label">Location Name</label>
                                    <input type="text" class="form-control" id="editLocationName">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editLocationAddress" class="form-label">Location Address</label>
                                    <input type="text" class="form-control" id="editLocationAddress">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editAppointmentStatus" class="form-label">Status</label>
                                    <select class="form-select" id="editAppointmentStatus">
                                        <option value="pending">Pending</option>
                                        <option value="confirmed">Confirmed</option>
                                        <option value="completed">Completed</option>
                                        <option value="complete">Complete</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editTransitTime" class="form-label">Transit Time (minutes)</label>
                                    <input type="number" class="form-control" id="editTransitTime">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editCustomRate" class="form-label">Custom Rate</label>
                                    <input type="number" class="form-control" id="editCustomRate" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editDriverAssigned" class="form-label">Driver Assigned</label>
                                    <input type="number" class="form-control" id="editDriverAssigned">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="editNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="editNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="deleteAppointment()">
                        <i class="bi bi-trash me-2"></i>Delete Appointment
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveAppointmentChanges()">
                        <i class="bi bi-check-lg me-2"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let allAppointments = [];
        let filteredAppointments = [];
        let currentEditingAppointment = null;

        // Load all appointments on page load
        async function loadAllAppointments() {
            try {
                const response = await fetch('https://webhook-processor-production-3bb8.up.railway.app/webhook/get-all-appointments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load appointments');
                }

                const data = await response.json();
                
                // Handle the nested response structure from your backend
                const appointmentsData = data[0]?.response?.body?.appointments || data.appointments;
                
                if (appointmentsData && Array.isArray(appointmentsData)) {
                    allAppointments = appointmentsData.map(apt => {
                        // Parse datetime fields - your backend uses different field names
                        let appointmentDateTime, pickupDateTime;
                        let appointmentDate = '', appointmentTime = '', pickupDate = '', pickupTime = '';

                        try {
                            if (apt.appointmentDateTime) {
                                appointmentDateTime = new Date(apt.appointmentDateTime);
                                if (!isNaN(appointmentDateTime.getTime())) {
                                    appointmentDate = apt.appointmentDate; // Backend already provides formatted date
                                    appointmentTime = apt.appointmentTime; // Backend already provides formatted time
                                }
                            }
                        } catch (e) {
                            console.warn('Invalid appointmentDateTime:', apt.appointmentDateTime);
                            appointmentDateTime = new Date();
                        }

                        try {
                            if (apt.pickupTime) {
                                pickupDateTime = new Date(apt.pickupTime);
                                if (!isNaN(pickupDateTime.getTime())) {
                                    pickupDate = pickupDateTime.toISOString().split('T')[0];
                                    pickupTime = pickupDateTime.toLocaleTimeString('en-US', { 
                                        hour: '2-digit', 
                                        minute: '2-digit' 
                                    });
                                }
                            }
                        } catch (e) {
                            console.warn('Invalid pickupTime:', apt.pickupTime);
                            pickupDateTime = appointmentDateTime || new Date();
                        }

                        return {
                            id: apt.id,
                            tableId: apt.id, // Store the actual database ID
                            knumber: apt.knumber || '',
                            clientName: apt.clientName || `${apt.clientFirstName || ''} ${apt.clientLastName || ''}`.trim() || 'Unknown Client',
                            appointmenttime: apt.appointmentDateTime || '', // Use the ISO datetime
                            pickuptime: apt.pickupTime || '', // Use the ISO datetime
                            locationname: apt.location || '', // Backend uses 'location' not 'locationname'
                            locationaddress: apt.locationAddress || '', // Backend uses 'locationAddress'
                            appointmentstatus: apt.status || 'pending', // Backend uses 'status' not 'appointmentstatus'
                            transittime: apt.transitTime || 0, // Backend uses 'transitTime'
                            custom_rate: apt.customRate, // Backend uses 'customRate'
                            driver_assigned: apt.driver_assigned,
                            notes: apt.notes || '',
                            appointmentDate: appointmentDate,
                            appointmentTime: appointmentTime,
                            appointmentDateTime: appointmentDateTime || new Date(),
                            pickupDate: pickupDate,
                            pickupTime: pickupTime
                        };
                    }); new Date(apt.appointmenttime);
                        let pickupDateTime = new Date(apt.pickuptime);

                        return {
                            id: apt.id,
                            tableId: apt.id, // Store the actual database ID
                            knumber: apt.knumber,
                            clientName: `${apt.firstname || ''} ${apt.lastname || ''}`.trim() || 'Unknown Client',
                            appointmenttime: apt.appointmenttime,
                            pickuptime: apt.pickuptime,
                            locationname: apt.locationname || '',
                            locationaddress: apt.locationaddress || '',
                            appointmentstatus: apt.appointmentstatus || 'pending',
                            transittime: apt.transittime || 0,
                            custom_rate: apt.custom_rate,
                            driver_assigned: apt.driver_assigned,
                            notes: apt.notes || '',
                            appointmentDate: appointmentDateTime.toISOString().split('T')[0],
                            appointmentTime: appointmentDateTime.toLocaleTimeString('en-US', { 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            }),
                            appointmentDateTime: appointmentDateTime,
                            pickupDate: pickupDateTime.toISOString().split('T')[0],
                            pickupTime: pickupDateTime.toLocaleTimeString('en-US', { 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            })
                        };
                    });

                    filteredAppointments = [...allAppointments];
                    displayAllAppointments();
                } else {
                    showError('No appointments found or invalid response format');
                }
            } catch (error) {
                console.error('Error loading appointments:', error);
                showError('Failed to load appointments. Please try again.');
            }
        }

        // Display appointments
        function displayAllAppointments() {
            const container = document.getElementById('allAppointmentsList');
            
            if (filteredAppointments.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="bi bi-calendar-x display-4 mb-3 d-block text-muted"></i>
                            <h5 class="text-muted">No appointments found</h5>
                            <p class="text-muted">Try adjusting your filter criteria.</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Sort appointments by appointment date/time
            filteredAppointments.sort((a, b) => a.appointmentDateTime - b.appointmentDateTime);

            let appointmentsHtml = `
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-list-ul me-2"></i>
                            All Appointments (${filteredAppointments.length})
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Client</th>
                                        <th>Date & Time</th>
                                        <th>Location</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;

            filteredAppointments.forEach(appointment => {
                appointmentsHtml += `
                    <tr>
                        <td>
                            <div class="fw-bold">${appointment.clientName}</div>
                            <small class="text-muted">${appointment.knumber}</small>
                        </td>
                        <td>
                            <div class="fw-bold">${appointment.appointmentDate}</div>
                            <small class="text-muted">${appointment.appointmentTime}</small>
                            ${appointment.pickupTime !== appointment.appointmentTime ? 
                                `<br><small class="text-info">Pickup: ${appointment.pickupTime}</small>` : ''}
                        </td>
                        <td>
                            <div class="fw-bold">${appointment.locationname}</div>
                            <small class="text-muted">${appointment.locationaddress}</small>
                        </td>
                        <td>
                            <span class="appointment-status status-${appointment.appointmentstatus}">
                                ${appointment.appointmentstatus}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editAppointment(${appointment.tableId})">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                        </td>
                    </tr>
                `;
            });

            appointmentsHtml += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = appointmentsHtml;
        }

        // Filter appointments
        function filterAppointments() {
            const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
            const clientFilter = document.getElementById('clientFilter').value.toLowerCase();
            const dateFilter = document.getElementById('dateFilter').value;
            const futureOnlyFilter = document.getElementById('futureOnlyFilter').value;

            const now = new Date();

            filteredAppointments = allAppointments.filter(appointment => {
                // Status filter
                const statusMatch = !statusFilter || appointment.appointmentstatus.toLowerCase() === statusFilter;
                
                // Client filter (search by name or K number)
                const clientMatch = !clientFilter || 
                    appointment.clientName.toLowerCase().includes(clientFilter) ||
                    appointment.knumber.toLowerCase().includes(clientFilter);
                
                // Date filter
                const dateMatch = !dateFilter || appointment.appointmentDate === dateFilter;
                
                // Future/Past filter
                let timeMatch = true;
                if (futureOnlyFilter) {
                    const appointmentDate = appointment.appointmentDateTime;
                    if (futureOnlyFilter === 'future') {
                        timeMatch = appointmentDate >= now;
                    } else if (futureOnlyFilter === 'past') {
                        timeMatch = appointmentDate < now;
                    }
                }

                return statusMatch && clientMatch && dateMatch && timeMatch;
            });

            displayAllAppointments();
        }

        // Edit appointment function
        function editAppointment(appointmentId) {
            const appointment = allAppointments.find(apt => apt.tableId === appointmentId);
            if (!appointment) {
                showError('Appointment not found');
                return;
            }

            currentEditingAppointment = appointment;

            // Populate form fields
            document.getElementById('editTableId').value = appointment.tableId;
            document.getElementById('editKNumber').value = appointment.knumber;
            
            // Convert datetime to the format expected by datetime-local input
            const appointmentDatetime = new Date(appointment.appointmenttime);
            const pickupDatetime = new Date(appointment.pickuptime);
            
            document.getElementById('editAppointmentTime').value = appointmentDatetime.toISOString().slice(0, 16);
            document.getElementById('editPickupTime').value = pickupDatetime.toISOString().slice(0, 16);
            document.getElementById('editLocationName').value = appointment.locationname;
            document.getElementById('editLocationAddress').value = appointment.locationaddress;
            document.getElementById('editAppointmentStatus').value = appointment.appointmentstatus;
            document.getElementById('editTransitTime').value = appointment.transittime;
            document.getElementById('editCustomRate').value = appointment.custom_rate || '';
            document.getElementById('editDriverAssigned').value = appointment.driver_assigned || '';
            document.getElementById('editNotes').value = appointment.notes;

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('editAppointmentModal'));
            modal.show();
        }

        // Save appointment changes
        async function saveAppointmentChanges() {
            if (!currentEditingAppointment) return;

            const formData = {
                id: currentEditingAppointment.tableId,
                knumber: document.getElementById('editKNumber').value,
                appointmenttime: document.getElementById('editAppointmentTime').value + ':00',
                pickuptime: document.getElementById('editPickupTime').value + ':00',
                locationname: document.getElementById('editLocationName').value,
                locationaddress: document.getElementById('editLocationAddress').value,
                appointmentstatus: document.getElementById('editAppointmentStatus').value,
                transittime: parseInt(document.getElementById('editTransitTime').value) || 0,
                custom_rate: parseFloat(document.getElementById('editCustomRate').value) || null,
                driver_assigned: parseInt(document.getElementById('editDriverAssigned').value) || null,
                notes: document.getElementById('editNotes').value
            };

            try {
                const response = await fetch('https://rrts-booking-system-production.up.railway.app/webhook/update-appointment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    throw new Error('Failed to update appointment');
                }

                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Appointment updated successfully!');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editAppointmentModal'));
                    modal.hide();
                    
                    // Reload appointments
                    loadAllAppointments();
                } else {
                    throw new Error(result.message || 'Update failed');
                }
            } catch (error) {
                console.error('Error updating appointment:', error);
                showError('Failed to update appointment. Please try again.');
            }
        }

        // Delete appointment function
        async function deleteAppointment() {
            if (!currentEditingAppointment) return;

            if (!confirm('Are you sure you want to delete this appointment? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch('https://rrts-booking-system-production.up.railway.app/webhook/delete-appointment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: currentEditingAppointment.tableId })
                });

                if (!response.ok) {
                    throw new Error('Failed to delete appointment');
                }

                const result = await response.json();
                
                if (result.success) {
                    showSuccess('Appointment deleted successfully!');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editAppointmentModal'));
                    modal.hide();
                    
                    // Reload appointments
                    loadAllAppointments();
                } else {
                    throw new Error(result.message || 'Delete failed');
                }
            } catch (error) {
                console.error('Error deleting appointment:', error);
                showError('Failed to delete appointment. Please try again.');
            }
        }

        // Utility functions
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;

            const container = document.getElementById('allAppointmentsList');
            container.insertBefore(errorDiv, container.firstChild);

            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;

            const container = document.getElementById('allAppointmentsList');
            container.insertBefore(successDiv, container.firstChild);

            setTimeout(() => successDiv.remove(), 5000);
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadAllAppointments();
            updateDateTime();
            setInterval(updateDateTime, 1000); // Update every second
        });

        // Update date and time in header
        function updateDateTime() {
            const now = new Date();
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit', 
                minute: '2-digit'
            };
            document.getElementById('currentDateTime').textContent = now.toLocaleDateString('en-US', options);
        }

        // Logout function
        function logout() {
            sessionStorage.removeItem('rrts_user');
            window.location.href = 'admin-portal_v3_2_3.html';
        }
    </script>
</body>
</html>

<!-- Version: v3.0.6 - Completely rewrote JavaScript section to fix syntax errors -->